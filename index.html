<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Herramientas - Caja de Ahorro y Crédito Tupak Rantina</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MathJax for formula rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Custom Styles and Tailwind Config -->
    <style>
        html {
            scrollbar-gutter: stable;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            margin: 0;
            padding: 0;
        }

        #loading-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
        }

        .loading-brand {
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        /* Hide main content initially */
        #app {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #app.show {
            opacity: 1;
            visibility: visible;
        }

        /* Ensure MathJax formula is visible on dark backgrounds */
        .mathjax-formula {
            color: white;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #e48410 #015cd0;
        }
        
        /* Modern scrollbar design */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #e48410 0%, #d97706 50%, #b45309 100%);
            border-radius: 8px;
            border: 2px solid #f8fafc;
            box-shadow: 0 2px 4px rgba(228, 132, 16, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #f59e0b 0%, #d97706 50%, #92400e 100%);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
            transform: scale(1.1);
        }
        
        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #f97316 0%, #ea580c 50%, #c2410c 100%);
            box-shadow: 0 6px 12px rgba(249, 115, 22, 0.5);
        }
        
        ::-webkit-scrollbar-corner {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 0 0 8px 0;
        }
        
        /* Firefox modern scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #e48410 #f8fafc;
        }
        
        /* Enhanced scrollbar for mobile */
        @media (max-width: 640px) {
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-thumb {
                border: 1px solid #f8fafc;
            }
            * {
                scrollbar-width: thin;
            }
        }
        
        /* Custom scrollbar for tables */
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #e48410 #f1f5f9;
        }
        
        .scroll-container::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb {
            background: #e48410;
            border-radius: 10px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #d97706;
        }
        
        /* Tab styles */
        .tab-container {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            color: #001749;
            border-bottom-color: #001749;
        }
        .tab-button:hover {
            color: #001749;
        }
        
        /* Estilos para menú móvil */
        .mobile-tab-button {
            color: #374151;
            font-weight: 500;
            transition: all 0.2s;
        }
        .mobile-tab-button:hover {
            color: #001749;
            background-color: #f9fafb;
        }
        .mobile-tab-button.active {
            color: #001749;
            background-color: #eff6ff;
        }
        
        /* Switch de Cartera - Botones grandes */
        #switch-slider {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #btn-cobros:active,
        #btn-general:active {
            transform: scale(0.98);
        }
        
        .tab-content {
            display: none;
            width: 100%;
            transition: opacity 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        
        /* Scrollbar para tarjetas de dashboard con fondos de color */
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .iframe-container {
            width: 100%;
            flex: 1;
            border: none;
        }
        
        /* Toast notifications */
        .toast {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Modal styles */
        #confirmation-modal {
            display: none;
        }
        
        #confirmation-modal.show {
            display: flex;
        }
        
        /* Login form styles */
        #login-container {
            display: none;
        }
        
        #login-container.show {
            display: flex;
        }
        
        /* Checklist styles */
        .document-checkbox {
            accent-color: #ff8c42;
        }
        
        .document-checkbox:checked {
            background-color: #ff8c42;
            border-color: #ff8c42;
        }
        
        .document-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 140, 66, 0.5);
        }
        
        /* Smooth transitions for row styling */
        .p-4 {
            transition: background-color 0.2s ease;
        }
        
        /* Custom checkbox styling for better visibility */
        .document-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid #d1d5db;
            appearance: none;
            background-color: white;
            cursor: pointer;
            position: relative;
        }
        
        .document-checkbox:checked::before {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        /* Responsive adjustments for mobile */
        @media (max-width: 640px) {
            .document-checkbox {
                width: 1.125rem;
                height: 1.125rem;
            }
            
            .document-checkbox:checked::before {
                font-size: 0.75rem;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark-blue': '#001749',
                        'brand-orange': '#e48410',
                        'brand-light-blue': '#3787c6',
                        'brand-accent-blue': '#015cd0',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" style="display: flex;">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="loading-text">Verificando sesión...</div>
            <div class="loading-brand">Centro de Herramientas</div>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-brand-dark-blue text-white py-6 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 ml-[5%] transition-all duration-300 ease-in-out">
                        <img src="https://i.postimg.cc/zBPmbxNT/TRANSPARENTE-min.png" 
                             alt="Centro de Servicios Públicos Logo" 
                             class="h-12 md:h-16 w-auto transition-all duration-300 ease-in-out">
                        <div class="text-left">
                            <h1 class="text-xl md:text-2xl font-bold transition-all duration-300 ease-in-out">Centro de Herramientas</h1>
                            <p class="text-gray-300 text-xs md:text-sm transition-all duration-300 ease-in-out">Caja de Ahorro y Crédito Tupak Rantina</p>
                        </div>
                    </div>
                    
                    <!-- User Info and Logout -->
                    <div class="flex items-center space-x-4">
                        <div class="text-right hidden md:block">
                            <div class="text-sm text-gray-300">Bienvenido</div>
                            <div id="user-info" class="font-semibold">Usuario</div>
                        </div>
                        <div id="logout-btn" class="hidden">
                            <!-- Logout button will be added by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-container bg-white">
            <!-- Botón hamburguesa a la izquierda y título único (solo móvil) -->
            <div class="md:hidden flex items-center p-4 relative" style="min-height:48px;">
                <button id="mobile-menu-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" style="position:relative; left:10px; z-index:20;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <span class="font-semibold text-gray-800 ml-4 truncate w-full text-center" id="current-tab-title" style="margin-left:44px;">Calculadora</span>
            </div>
            
            <!-- Menú móvil (oculto por defecto) - Sin Imprimibles -->
            <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-200 absolute left-0 top-0 mt-12 w-full z-50 shadow-lg" style="min-width:200px;">
                <button class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100" onclick="switchTab(0, 'Calculadora', true)">
                    <i class="fas fa-calculator mr-3 text-blue-600"></i>Calculadora
                </button>
                <button class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100" onclick="switchTab(1, 'Herramientas de Consulta', true)">
                    <i class="fas fa-search mr-3 text-green-600"></i>Herramientas de Consulta
                </button>
                <button class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100" onclick="switchTab(2, 'Documentación', true)">
                    <i class="fas fa-book mr-3 text-purple-600"></i>Documentación
                </button>
                <button class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100" onclick="switchTab(3, 'Imprimibles', true)">
                    <i class="fas fa-print mr-3 text-red-600"></i>Imprimibles
                </button>
                <button id="mobile-cartera-tab" class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 hidden" onclick="switchTab(4, 'Cartera', true)">
                    <i class="fas fa-wallet mr-3 text-indigo-600"></i>Cartera
                </button>
                <button class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 hidden" onclick="switchTab(5, 'Autorización Exterior', true)">
                    <i class="fas fa-user-check mr-3 text-orange-600"></i>Autorización Exterior
                </button>
                <button id="mobile-comite-tab" class="mobile-tab-button w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors hidden" onclick="window.location.href='cargacomite.html'">
                    <i class="fas fa-upload mr-3 text-teal-600"></i>Cargar Comité
                </button>
            </div>
            
            <!-- Pestañas desktop (ocultas en móvil) -->
            <div class="hidden md:flex">
                <button class="tab-button active" onclick="switchTab(0, 'Calculadora')">Calculadora</button>
                <button class="tab-button" onclick="switchTab(1, 'Herramientas de Consulta')">Herramientas de Consulta</button>
                <button class="tab-button" onclick="switchTab(2, 'Documentación')">Documentación</button>
                <button class="tab-button" onclick="switchTab(3, 'Imprimibles')">Imprimibles</button>
                <button id="desktop-cartera-tab" class="tab-button hidden" onclick="switchTab(4, 'Cartera')">Cartera</button>
                <button class="tab-button hidden" onclick="switchTab(5, 'Autorización Exterior')">Autorización Exterior</button>
                <button id="desktop-comite-tab" class="tab-button hidden" onclick="window.location.href='cargacomite.html'">Cargar Comité</button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab0" class="tab-content active">
        <!-- Main Content -->
        <main class="flex-grow py-6 px-4 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                
                <!-- Calculator Section -->
                <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-8">
                    <div class="lg:flex">
                        <!-- Left Side: Information -->
                        <div class="lg:w-1/3 p-6 bg-brand-accent-blue text-white">
                            <h2 class="text-2xl font-bold mb-4">Calculadora Financiera</h2>
                            <p class="text-gray-200 mb-4 text-sm">
                                Configure el tipo de financiamiento y calcule el monto total, tabla de amortización y costos.
                            </p>
                            
                            <!-- Formula Display -->
                            <div class="bg-white/20 p-3 rounded-lg mb-4">
                                <p class="font-semibold text-xs mb-2">Fórmulas Aplicadas:</p>
                                <div class="mathjax-formula text-xs">
                                    $$ \text{Cuota} = \frac{P \times r \times (1+r)^n}{(1+r)^n - 1} $$
                                </div>
                                <div class="mathjax-formula text-xs">
                                    $$ \text{Financ.} = \frac{\text{Neto}}{1 - \frac{\%Desc.}{100}} $$
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-200">
                                <p><strong>P:</strong> Capital | <strong>r:</strong> Tasa mensual | <strong>n:</strong> Períodos</p>
                            </div>
                        </div>

                        <!-- Right Side: Calculator Form -->
                        <div class="lg:w-2/3 p-6">
                            <div class="grid md:grid-cols-2 gap-6">
                                
                                <!-- Column 1: Basic Data -->
                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold text-brand-dark-blue border-b border-gray-200 pb-2">Datos Básicos</h3>
                                    
                                    <!-- Net Amount -->
                                    <div>
                                        <label for="netAmount" class="block text-sm font-medium text-gray-700">Monto Neto Requerido ($)</label>
                                        <input type="number" id="netAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-accent-blue focus:ring-brand-accent-blue" placeholder="Ej: 30000">
                                    </div>

                                    <!-- Credit Product Type -->
                                    <div>
                                        <label for="creditProduct" class="block text-sm font-medium text-gray-700">Producto de Crédito</label>
                                        <select id="creditProduct" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-accent-blue focus:ring-brand-accent-blue">
                                            <option value="26">Microcrédito Minorista - 26%</option>
                                            <option value="23">Microcrédito Simple - 23%</option>
                                            <option value="19" data-product="ampliado">Microcrédito Ampliado - 19%</option>
                                            <option value="24">Nuestras Raíces - 24%</option>
                                            <option value="19" data-product="consumo">Consumo - 19%</option>
                                        </select>
                                    </div>

                                    <!-- Term in months -->
                                    <div>
                                        <label for="termMonths" class="block text-sm font-medium text-gray-700">Plazo (meses)</label>
                                        <input type="number" id="termMonths" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-accent-blue focus:ring-brand-accent-blue" placeholder="Ej: 18">
                                    </div>

                                    <!-- SOLCA Percentage -->
                                    <div>
                                        <label for="solcaPercentage" class="block text-sm font-medium text-gray-700">SOLCA (%) - Fijo</label>
                                        <input type="number" id="solcaPercentage" step="0.001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 cursor-not-allowed" value="0.05" readonly>
                                    </div>

                                    <!-- Autoseguro Percentage -->
                                    <div>
                                        <label for="autoseguroPercentage" class="block text-sm font-medium text-gray-700">Autoseguro (%) - Fijo</label>
                                        <input type="number" id="autoseguroPercentage" step="0.001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50 cursor-not-allowed" value="0.72" readonly>
                                    </div>


                                </div>

                                <!-- Column 2: Patrimonial Contribution Options -->
                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold text-brand-dark-blue border-b border-gray-200 pb-2">Aporte Patrimonial</h3>
                                    
                                    <!-- Patrimonial Contribution Percentage -->
                                    <div>
                                        <label for="patrimonialPercentage" class="block text-sm font-medium text-gray-700">Porcentaje Aporte (%)</label>
                                        <select id="patrimonialPercentage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-accent-blue focus:ring-brand-accent-blue">
                                            <option value="2.75">2.75%</option>
                                            <option value="2.25">2.25%</option>
                                        </select>
                                    </div>

                                    <!-- Financing Option -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Financiamiento</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="radio" name="financingType" value="discount" class="text-brand-accent-blue focus:ring-brand-accent-blue" checked>
                                                <span class="ml-2 text-sm">Descontar del crédito</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="financingType" value="finance" class="text-brand-accent-blue focus:ring-brand-accent-blue">
                                                <span class="ml-2 text-sm">Financiar aporte</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="space-y-3 mt-4">
                                        <!-- Generate Button -->
                                        <button id="generateBtn" class="w-full bg-brand-orange hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-md transition duration-200">
                                            Generar Cálculos
                                        </button>
                                        
                                        <!-- Clear Button -->
                                        <button id="clearBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 text-sm mt-2">
                                            <i class="fas fa-trash-alt mr-2"></i>Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="grid lg:grid-cols-2 gap-8" style="display: none;">
                    
                    <!-- Summary Card -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-brand-dark-blue mb-4">Resumen del Crédito</h3>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Producto de Crédito:</span>
                                <span id="summaryProductName" class="font-semibold text-brand-dark-blue">-</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Monto Neto Solicitado:</span>
                                <span id="summaryNetAmount" class="font-semibold">$0.00</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Aporte Patrimonial:</span>
                                <span id="summaryPatrimonialAmount" class="font-semibold">$0.00</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Monto Total del Crédito:</span>
                                <span id="summaryTotalCredit" class="font-semibold text-brand-orange text-lg">$0.00</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Desembolso Neto:</span>
                                <span id="summaryNetDisbursement" class="font-semibold text-green-600 text-lg">$0.00</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Cuota Mensual:</span>
                                <span id="summaryBasePayment" class="font-semibold text-blue-600 text-lg">$0.00</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">SOLCA (al desembolso):</span>
                                <span id="summarySolcaAmount" class="font-semibold text-gray-600">$0.00</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-gray-600">Autoseguro (al desembolso):</span>
                                <span id="summaryAutoseguroAmount" class="font-semibold text-gray-600">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total a Pagar (en cuotas):</span>
                                <span id="summaryTotalToPay" class="font-semibold">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info Card -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-brand-dark-blue mb-4">Información Adicional</h3>
                        
                        <div class="space-y-3">
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <strong>Tipo de Financiamiento:</strong> 
                                    <span id="financingTypeDisplay">Descuento del crédito</span>
                                </p>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Tasa Mensual:</span>
                                    <span id="monthlyRateDisplay" class="font-medium">0.00%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Total SOLCA:</span>
                                    <span id="totalSolcaDisplay" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Total Autoseguro:</span>
                                    <span id="totalAutoseguroDisplay" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Total Intereses:</span>
                                    <span id="totalInterestDisplay" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Plazo:</span>
                                    <span id="termDisplay" class="font-medium">0 meses</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amortization Table -->
                <div id="amortizationSection" class="mt-8 bg-white rounded-lg shadow-lg p-6" style="display: none;">
                    <h3 class="text-xl font-bold text-brand-dark-blue mb-4">Tabla de Amortización</h3>
                    
                    <div class="overflow-x-auto scroll-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="amortizationTableHeader">
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuota</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Inicial</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuota Base</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interés</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capital</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SOLCA</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Autoseguro</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuota Total</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Final</th>
                                </tr>
                            </thead>
                            <tbody id="amortizationTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        </div>

        <div id="tab1" class="tab-content">
            <div class="flex flex-col h-full bg-gray-50">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-brand-dark-blue mb-6">Herramientas de Consulta</h2>
                    <!-- Gallery Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">

                                            
                        <!-- Consulta Ecuador Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://srienlinea.sri.gob.ec/sri-en-linea/SriPagosWeb/ConsultaDeudasFirmesImpugnadas/Consultas/consultaDeudasFirmesImpugnadas', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/1pFyHvGxdIi_zqXpuwtK8WBrKQdUSFkpE=w2048?name=Screenshot%202025-10-27%20092708.png" 
                                     alt="Verificar Nombres con Cédula" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Verificar Nombres con Cédula</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Consulta y verifica nombres asociados a números de cédula en Ecuador.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Autorización Buró de Crédito Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('autorizacion.html', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/1Ad540QfeZwub_InNyxbb0v3m0lrWfcAy=w2048?name=Screenshot%202025-09-14%20114903.png" 
                                     alt="Autorización de revisión del buró crediticio" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Autorización de revisión del buró crediticio</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Genera una autorización formal para la consulta de tu historial crediticio.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Generar documento</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Equifax Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://interactivereports.equifax.com/ir/report', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/1fVSs_tfen9B9XtDa1NzZErbUfNkgRXlw=w2048?name=Screenshot%202025-09-10%20165545.png" 
                                     alt="Equifax Buró de Crédito" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Equifax Buró de Crédito</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Consulta tu historial crediticio y reportes de crédito con Equifax Ecuador.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Consulta Judicial Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://procesosjudiciales.funcionjudicial.gob.ec/busqueda-filtros', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/1DlLnxlxRWev6PnrTABPpUgZKa1u-Jq-h=w2048?name=Screenshot%202025-09-10%20164635.png" 
                                     alt="Consulta de Procesos Judiciales" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Consulta de Procesos Judiciales</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Accede al sistema de consulta de procesos judiciales de la Función Judicial del Ecuador.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SUPA Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://supa.funcionjudicial.gob.ec/pensiones/publico/consulta.jsf', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/18KYmHmmyL3jC86EdCVOcIersc0WuQqhO=w2048?name=Screenshot%202025-09-10%20165148.png" 
                                     alt="Sistema Único de Pensiones Alimenticias - SUPA" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">SUPA</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Sistema Único de Pensiones Alimenticias - Consulta de pensiones alimenticias.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SRI RUC Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://srienlinea.sri.gob.ec/sri-en-linea/SriRucWeb/ConsultaRuc/Consultas/consultaRuc', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/1QMiZTDTbqoJZT-IjXWDELXGojLWBlotl=w2048?name=Screenshot%202025-09-10%20174559.png" 
                                     alt="Consulta RUC - SRI" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Consulta RUC - SRI</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Consulta información de RUC y datos tributarios con el Servicio de Rentas Internas.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consulta de Catastros Cantón Mejía Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('municipio.html', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/1F_ZL-uUIuHITdumFJoK8Ex3wIGXcCndE=w2048?name=Screenshot%202025-09-18%20113024.png" 
                                     alt="Consulta de Catastros - Cantón Mejía" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Consulta de Catastros en el Cantón Mejía</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Consulta información catastral y verifica propiedades en el Cantón Mejía.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consulta de Catastros Latacunga Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://servltga.latacunga.gob.ec/portal_ec/latacunga.php', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/14LMKezmM_4oNT2-xJqHH4BMGjSMAg_Vb=w2048?name=Screenshot%202025-10-15%20111736.png" 
                                     alt="Consulta de Catastros - Latacunga" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Consulta de Catastros de Latacunga</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Consulta información catastral y verifica propiedades en el Cantón Latacunga.
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ANT Multas Card -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer group max-w-sm mx-auto w-full" 
                             onclick="window.open('https://ant.com.ec/multas-transito', '_blank')">
                            <div class="aspect-video bg-gray-200 relative overflow-hidden">
                                <img src="https://lh3.googleusercontent.com/d/165EU5e_h4u_FaZ1DNQb3r4X5_pqfZnyi=w2048?name=Screenshot%202025-09-10%20174152.png" 
                                     alt="Multas de Tránsito ANT" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-brand-dark-blue mb-2">Multas de Tránsito</h3>
                                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">
                                    Consulta y verifica multas de tránsito con la Agencia Nacional de Tránsito (ANT).
                                </p>
                                <div class="flex items-center text-brand-accent-blue text-xs md:text-sm font-medium">
                                    <span>Acceder al sistema</span>
                                    <svg class="w-3 h-3 md:w-4 md:h-4 ml-1 md:ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden opacity-50 max-w-sm mx-auto w-full">
                            <div class="aspect-video bg-gray-200 flex items-center justify-center">
                                <div class="text-center text-gray-400">
                                    <svg class="w-8 h-8 md:w-12 md:h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <p class="text-xs md:text-sm">Próximamente</p>
                                </div>
                            </div>
                            <div class="p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-400 mb-2">Nueva Herramienta</h3>
                                <p class="text-gray-400 text-xs md:text-sm">
                                    Espacio reservado para futuras herramientas de consulta.
                                </p>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <div class="flex flex-col h-full bg-gray-50">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-brand-dark-blue mb-6">
                        <i class="fas fa-file-alt mr-2"></i>
                        Documentación para armar carpeta digital y física de créditos.
                    </h2>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="bg-blue-50 border-l-4 border-brand-accent-blue p-4 mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-brand-accent-blue"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">
                                        Guía para Asesores - Documentación de Créditos
                                    </h3>
                                    <p class="mt-2 text-sm text-blue-700">
                                        <strong>IMPORTANTE:</strong> Envía todo en <strong>un solo PDF consolidado</strong>, siguiendo este orden y cuidando <span class="font-semibold">orientación correcta</span>, <span class="font-semibold">sin sombras</span>, <span class="font-semibold">escaneo nítido</span> y <span class="font-semibold">orden según la guía</span>.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <!-- Control de Checklist -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <span id="checklistStatus">Checklist se reinicia automáticamente cada 7 días</span>
                                </div>
                                <button id="resetChecklistBtn" class="bg-brand-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center">
                                    <i class="fas fa-refresh mr-2"></i>
                                    Reiniciar Checklist
                                </button>
                            </div>
                        </div>

                            <!-- Lista de documentos requeridos -->
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-brand-dark-blue">Documentos Requeridos (en orden)</h3>
                                    <div class="text-sm text-gray-600">
                                        <span id="completedCount">0</span> de <span id="totalCount">14</span> completados
                                    </div>
                                </div>
                                <div class="divide-y divide-gray-200">
                                    <div class="px-4 py-2 bg-blue-50">
                                        <div class="text-sm font-semibold text-brand-accent-blue">Información Personal</div>
                                        <div class="text-xs text-gray-600 mt-1">Según corresponda: titular, cónyuge, garante, cónyuge del garante</div>
                                    </div>
                                    
                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc1" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="1">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">1</span>
                                            <div class="flex-1">
                                                <label for="doc1" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Copia de Cédula</h4>
                                                    <p class="text-sm text-gray-600">(Opcional: Papeleta de votación)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="px-4 py-2 bg-blue-50">
                                        <div class="text-sm font-semibold text-brand-accent-blue">Información de Consulta</div>
                                        <div class="text-xs text-gray-600 mt-1">De cada persona involucrada en Información Personal</div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc2" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="2">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">2</span>
                                            <div class="flex-1">
                                                <label for="doc2" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Autorización de Revisión de Buró</h4>
                                                    <p class="text-sm text-gray-600">Documento firmado por el solicitante</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc3" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="3">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">3</span>
                                            <div class="flex-1">
                                                <label for="doc3" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Buró</h4>
                                                    <p class="text-sm text-gray-600">Reporte de historial crediticio</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc4" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="4">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">4</span>
                                            <div class="flex-1">
                                                <label for="doc4" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Revisión de Demandas Judiciales</h4>
                                                    <p class="text-sm text-gray-600">Consulta de procesos judiciales activos</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc5" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="5">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">5</span>
                                            <div class="flex-1">
                                                <label for="doc5" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Revisión de SUPA</h4>
                                                    <p class="text-sm text-gray-600">Sistema Único de Pensiones Alimenticias</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="px-4 py-2 bg-blue-50 text-sm font-semibold text-brand-accent-blue">
                                        Información Económica
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc6" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="6">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">6</span>
                                            <div class="flex-1">
                                                <label for="doc6" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Informe de Ingresos y Egresos</h4>
                                                    <p class="text-sm text-gray-600">Detalle financiero del solicitante</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc7" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="7">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">7</span>
                                            <div class="flex-1">
                                                <label for="doc7" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Hoja de Costos</h4>
                                                    <p class="text-sm text-gray-600">Cálculo de costos de producción (opcional)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc8" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="8">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">8</span>
                                            <div class="flex-1">
                                                <label for="doc8" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Facturas de Compra/Venta</h4>
                                                    <p class="text-sm text-gray-600 italic">(Si aplica - para actividades comerciales)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc9" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="9">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">9</span>
                                            <div class="flex-1">
                                                <label for="doc9" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Carnet de Sustento de Actividad</h4>
                                                    <p class="text-sm text-gray-600">Ejemplos para Mejía y Cotopaxi:</p>
                                                    <ul class="text-sm text-gray-600 mt-2 ml-4 list-disc">
                                                        <li>CONEFA (Consorcio de Empresas Florícolas)</li>
                                                        <li>Certificado de la Asociación de Ganaderos de Cotopaxi</li>
                                                        <li>Registro de la Cámara de Agricultura de Cotopaxi</li>
                                                        <li>Certificado de MAGAP (Ministerio de Agricultura)</li>
                                                        <li>Registro en la Asociación de Productores Agrícolas de Mejía</li>
                                                        <li>Carnet de la Federación de Ganaderos del Ecuador (FEDEGAN)</li>
                                                        <li>Certificado de la Unión de Organizaciones Campesinas de Cotopaxi</li>
                                                    </ul>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc10" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="10">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">10</span>
                                            <div class="flex-1">
                                                <label for="doc10" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Certificado de Trabajo</h4>
                                                    <p class="text-sm text-gray-600 italic">(Si aplica - para empleados en relación de dependencia)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc11" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="11">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">11</span>
                                            <div class="flex-1">
                                                <label for="doc11" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Referencias Comerciales</h4>
                                                    <p class="text-sm text-gray-600">(Opcional - cartas de proveedores o clientes)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="px-4 py-2 bg-blue-50">
                                        <div class="text-sm font-semibold text-brand-accent-blue">Anexos</div>
                                        <div class="text-xs text-gray-600 mt-1">Fotografías claras</div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc12" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="12">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">12</span>
                                            <div class="flex-1">
                                                <label for="doc12" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Matrícula de Vehículo</h4>
                                                    <p class="text-sm text-gray-600 italic">(Si aplica - para créditos vehiculares o como garantía)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc13" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="13">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">13</span>
                                            <div class="flex-1">
                                                <label for="doc13" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Impuesto Predial</h4>
                                                    <p class="text-sm text-gray-600 italic">(Si aplica - para propietarios de bienes inmuebles)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc14" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="14">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">14</span>
                                            <div class="flex-1">
                                                <label for="doc14" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Croquis</h4>
                                                    <p class="text-sm text-gray-600">Ubicación geográfica del domicilio</p>
                                                </label>
                                                <button onclick="window.open('croquis.html', '_blank')" class="mt-2 px-4 py-2 bg-brand-orange text-white rounded-lg hover:bg-orange-600 transition-colors text-sm font-medium">
                                                    <i class="fas fa-map-marked-alt mr-2"></i>Generar
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-4 hover:bg-gray-50 transition-colors">
                                        <div class="flex items-start">
                                            <div class="flex items-center mr-3">
                                                <input type="checkbox" id="doc15" class="document-checkbox w-5 h-5 text-brand-orange focus:ring-brand-orange border-gray-300 rounded" data-doc="15">
                                            </div>
                                            <span class="flex-shrink-0 w-8 h-8 bg-brand-orange text-white rounded-full flex items-center justify-center text-sm font-bold mr-4">15</span>
                                            <div class="flex-1">
                                                <label for="doc15" class="cursor-pointer">
                                                    <h4 class="font-semibold text-gray-900">Cartilla de Servicios Básicos</h4>
                                                    <p class="text-sm text-gray-600">Planilla de luz o agua (últimos 3 meses)</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Notas importantes -->
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">
                                            Notas Importantes
                                        </h3>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <ul class="list-disc list-inside space-y-1">
                                                <li><strong>UN SOLO ARCHIVO PDF CONSOLIDADO</strong> con todos los documentos en orden</li>
                                                <li>La calidad de escaneo debe permitir la lectura clara del contenido</li>
                                                <li>Respetar el orden establecido para agilizar el proceso de revisión</li>
                                                <li>Los documentos marcados como "Si aplica" solo se incluyen cuando corresponda al caso específico</li>
                                                <li>Para actividades agropecuarias en Mejía y Cotopaxi, verificar el tipo de carnet o certificado más apropiado</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    <div id="tab3" class="tab-content hidden">
            <div class="flex flex-col h-full bg-gray-50">
                <div class="p-6">
                    <iframe src="acta-credito.html" width="100%" height="800" frameborder="0"></iframe>
                </div>
            </div>
        </div>

        <div id="tab4" class="tab-content hidden">
            <div class="flex flex-col h-full bg-gray-50">
                <div class="p-6 max-w-7xl mx-auto w-full">
                    <!-- Loading State del Switch -->
                    <div id="cartera-switch-loading" class="bg-gray-100 rounded-lg shadow-md mb-6 border border-gray-200 p-6">
                        <div class="flex items-center justify-center gap-3">
                            <i class="fas fa-spinner fa-spin text-2xl text-indigo-600"></i>
                            <p class="text-gray-700 font-medium">Cargando cartera...</p>
                        </div>
                    </div>
                    
                    <!-- Switch de Vistas: Cobros Próximos / General -->
                    <div id="cartera-switch-container" class="bg-gray-100 rounded-lg shadow-md mb-6 border border-gray-200 p-2 hidden">
                        <div class="flex items-center justify-center">
                            <div class="relative inline-flex bg-white rounded-lg p-1 shadow-inner w-full max-w-3xl">
                                <!-- Background slider animado -->
                                <div id="switch-slider" class="absolute top-1 left-1 h-[calc(100%-8px)] w-[calc(33.333%-4px)] bg-gradient-to-r from-red-500 to-red-600 rounded-md shadow-md transition-transform duration-300 ease-in-out"></div>
                                
                                <!-- Botón Atrasados -->
                                <button 
                                    id="btn-atrasados" 
                                    onclick="setCarteraView('atrasados')"
                                    class="relative z-10 flex-1 px-6 py-3 text-sm font-semibold rounded-md transition-all duration-300 text-white"
                                >
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Atrasados
                                </button>
                                
                                <!-- Botón Cobros Próximos -->
                                <button 
                                    id="btn-cobros" 
                                    onclick="setCarteraView('cobros')"
                                    class="relative z-10 flex-1 px-6 py-3 text-sm font-medium rounded-md transition-all duration-300 text-gray-600 hover:text-gray-800"
                                >
                                    <i class="fas fa-calendar-check mr-2"></i>
                                    Cobros Próximos
                                </button>
                                
                                <!-- Botón General -->
                                <button 
                                    id="btn-general" 
                                    onclick="setCarteraView('general')"
                                    class="relative z-10 flex-1 px-6 py-3 text-sm font-medium rounded-md transition-all duration-300 text-gray-600 hover:text-gray-800"
                                >
                                    <i class="fas fa-th-list mr-2"></i>
                                    General
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Vista Atrasados -->
                    <div id="cartera-view-atrasados" class="hidden">
                        <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                            <!-- Header -->
                            <div class="bg-gradient-to-r from-red-500 to-red-600 p-6">
                                <h2 class="text-2xl font-bold text-white flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-3"></i>
                                    Pagos Atrasados
                                </h2>
                                <p class="text-red-100 mt-2">Créditos con pagos vencidos y pendientes</p>
                            </div>

                            <!-- Stats -->
                            <div class="p-6 bg-gray-50 border-b">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-4 rounded-lg shadow-sm border border-red-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Pagos Atrasados</p>
                                                <p class="text-2xl font-bold text-red-600" id="atrasados-count">0</p>
                                            </div>
                                            <i class="fas fa-exclamation-circle text-3xl text-red-200"></i>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow-sm border border-red-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Monto en Mora</p>
                                                <p class="text-2xl font-bold text-red-600" id="atrasados-monto-total">$0</p>
                                            </div>
                                            <i class="fas fa-hand-holding-usd text-3xl text-red-200"></i>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow-sm border border-red-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Usuario</p>
                                                <p class="text-lg font-semibold text-gray-700" id="atrasados-user-email">-</p>
                                            </div>
                                            <i class="fas fa-user text-3xl text-gray-200"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-100 border-b-2 border-red-300">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                <i class="fas fa-calendar-times mr-1"></i>Fecha Vencida
                                            </th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Días Retraso</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Acta</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Socio</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Cédula</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Teléfono</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Asesor</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="atrasados-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Loading state -->
                                        <tr>
                                            <td colspan="9" class="px-4 py-8 text-center">
                                                <i class="fas fa-spinner fa-spin text-3xl text-red-600 mb-2"></i>
                                                <p class="text-gray-600">Cargando pagos atrasados...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Vista Cobros Próximos -->
                    <div id="cartera-view-cobros" class="hidden">
                        <!-- Tabla de Créditos Sin Fecha Asignada (arriba) -->
                        <div id="sin-fecha-container" class="hidden mb-6">
                            <div class="bg-white rounded-lg shadow-xl overflow-hidden border-l-4 border-yellow-500">
                                <!-- Header -->
                                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-4">
                                    <h3 class="text-lg font-bold text-white flex items-center">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        Créditos Pendientes de Configurar
                                        <span id="sin-fecha-count" class="ml-2 bg-white text-yellow-700 px-3 py-1 rounded-full text-sm font-bold">0</span>
                                    </h3>
                                </div>

                                <!-- Table -->
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-yellow-50 border-b-2 border-yellow-300">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Socio</th>
                                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Cédula</th>
                                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
                                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sin-fecha-table-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                            <!-- Header -->
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-6">
                                <h2 class="text-2xl font-bold text-white flex items-center">
                                    <i class="fas fa-calendar-check mr-3"></i>
                                    Cobros Próximos (5 días)
                                </h2>
                                <p class="text-orange-100 mt-2">Créditos con día de pago en los próximos 5 días</p>
                            </div>

                            <!-- Stats -->
                            <div class="p-6 bg-gray-50 border-b">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Cobros Pendientes</p>
                                                <p class="text-2xl font-bold text-orange-600" id="cobros-pendientes-count">0</p>
                                            </div>
                                            <i class="fas fa-clock text-3xl text-orange-200"></i>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Monto a Cobrar</p>
                                                <p class="text-2xl font-bold text-green-600" id="cobros-monto-total">$0</p>
                                            </div>
                                            <i class="fas fa-money-bill-wave text-3xl text-green-200"></i>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Usuario</p>
                                                <p class="text-lg font-semibold text-gray-700" id="cobros-user-email">-</p>
                                            </div>
                                            <i class="fas fa-user text-3xl text-gray-200"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-100 border-b-2 border-gray-300">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                <i class="fas fa-calendar mr-1"></i>Día Pago
                                            </th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Días Restantes</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Socio</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Cédula</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Asesor</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cobros-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Loading state -->
                                        <tr>
                                            <td colspan="7" class="px-4 py-8 text-center">
                                                <i class="fas fa-spinner fa-spin text-3xl text-orange-600 mb-2"></i>
                                                <p class="text-gray-600">Cargando cobros próximos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Vista General -->
                    <div id="cartera-view-general" class="hidden">
                        <!-- Admin Dashboard (solo para contacto@tupakrantina.com) -->
                    <div id="admin-dashboard" class="mb-6 hidden">
                        <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-6">
                            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6">
                                <h2 class="text-2xl font-bold text-white flex items-center">
                                    <i class="fas fa-chart-line mr-3"></i>
                                    Dashboard Administrativo
                                </h2>
                                <p class="text-purple-100 mt-2">Estadísticas generales de cartera</p>
                            </div>
                            
                            <div class="p-6">
                                <!-- Métricas principales -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl shadow-lg text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-file-invoice-dollar text-3xl opacity-80"></i>
                                            <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">Total</span>
                                        </div>
                                        <p class="text-sm opacity-90">Total Créditos</p>
                                        <p class="text-3xl font-bold" id="dashboard-total-creditos">0</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-xl shadow-lg text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-dollar-sign text-3xl opacity-80"></i>
                                            <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">Global</span>
                                        </div>
                                        <p class="text-sm opacity-90">Monto Total</p>
                                        <p class="text-2xl font-bold" id="dashboard-monto-total">$0</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-5 rounded-xl shadow-lg text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-coins text-3xl opacity-80"></i>
                                            <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">Vigente</span>
                                        </div>
                                        <p class="text-sm opacity-90">Capital Vigente</p>
                                        <p class="text-2xl font-bold" id="dashboard-capital-vigente">$0</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-5 rounded-xl shadow-lg text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-chart-bar text-3xl opacity-80"></i>
                                            <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">Promedio</span>
                                        </div>
                                        <p class="text-sm opacity-90">Promedio Monto</p>
                                        <p class="text-2xl font-bold" id="dashboard-promedio-monto">$0</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-5 rounded-xl shadow-lg text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-users text-3xl opacity-80"></i>
                                            <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">Activos</span>
                                        </div>
                                        <p class="text-sm opacity-90">Asesores</p>
                                        <p class="text-3xl font-bold" id="dashboard-total-asesores">0</p>
                                    </div>
                                </div>

                                <!-- Últimos 3 Meses -->
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-calendar-days mr-2 text-blue-600"></i>
                                        Últimos 3 Meses
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <!-- Mes Actual -->
                                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-xl shadow-lg text-white">
                                            <div class="flex items-center justify-between mb-3">
                                                <i class="fas fa-calendar-check text-2xl opacity-80"></i>
                                                <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">Actual</span>
                                            </div>
                                            <p class="text-sm opacity-90 font-semibold mb-3" id="dashboard-month-0-name">-</p>
                                            <div class="space-y-1 mb-3 pb-3 border-b border-white/20">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs opacity-90">Total Créditos:</span>
                                                    <span class="text-xl font-bold" id="dashboard-month-0-count">0</span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs opacity-90">Monto Total:</span>
                                                    <span class="text-lg font-bold" id="dashboard-month-0-amount">$0</span>
                                                </div>
                                                <div class="flex items-center justify-between border-t border-white/10 pt-1">
                                                    <span class="text-xs opacity-90">Capital Vigente:</span>
                                                    <span class="text-lg font-bold" id="dashboard-month-0-capital">$0</span>
                                                </div>
                                            </div>
                                            <div class="space-y-1">
                                                <p class="text-xs opacity-75 font-semibold mb-2 flex items-center">
                                                    <i class="fas fa-users mr-1"></i>
                                                    Por Asesor:
                                                </p>
                                                <div id="dashboard-month-0-asesores" class="max-h-32 overflow-y-auto scrollbar-thin">
                                                    <!-- Asesores will be inserted here -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mes -1 -->
                                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl shadow-lg text-white">
                                            <div class="flex items-center justify-between mb-3">
                                                <i class="fas fa-calendar-minus text-2xl opacity-80"></i>
                                                <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">-1</span>
                                            </div>
                                            <p class="text-sm opacity-90 font-semibold mb-3" id="dashboard-month-1-name">-</p>
                                            <div class="space-y-1 mb-3 pb-3 border-b border-white/20">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs opacity-90">Total Créditos:</span>
                                                    <span class="text-xl font-bold" id="dashboard-month-1-count">0</span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs opacity-90">Monto Total:</span>
                                                    <span class="text-lg font-bold" id="dashboard-month-1-amount">$0</span>
                                                </div>
                                                <div class="flex items-center justify-between border-t border-white/10 pt-1">
                                                    <span class="text-xs opacity-90">Capital Vigente:</span>
                                                    <span class="text-lg font-bold" id="dashboard-month-1-capital">$0</span>
                                                </div>
                                            </div>
                                            <div class="space-y-1">
                                                <p class="text-xs opacity-75 font-semibold mb-2 flex items-center">
                                                    <i class="fas fa-users mr-1"></i>
                                                    Por Asesor:
                                                </p>
                                                <div id="dashboard-month-1-asesores" class="max-h-32 overflow-y-auto scrollbar-thin">
                                                    <!-- Asesores will be inserted here -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mes -2 -->
                                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-5 rounded-xl shadow-lg text-white">
                                            <div class="flex items-center justify-between mb-3">
                                                <i class="fas fa-calendar text-2xl opacity-80"></i>
                                                <span class="text-xs font-semibold bg-white/20 px-2 py-1 rounded">-2</span>
                                            </div>
                                            <p class="text-sm opacity-90 font-semibold mb-3" id="dashboard-month-2-name">-</p>
                                            <div class="space-y-1 mb-3 pb-3 border-b border-white/20">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs opacity-90">Total Créditos:</span>
                                                    <span class="text-xl font-bold" id="dashboard-month-2-count">0</span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs opacity-90">Monto Total:</span>
                                                    <span class="text-lg font-bold" id="dashboard-month-2-amount">$0</span>
                                                </div>
                                                <div class="flex items-center justify-between border-t border-white/10 pt-1">
                                                    <span class="text-xs opacity-90">Capital Vigente:</span>
                                                    <span class="text-lg font-bold" id="dashboard-month-2-capital">$0</span>
                                                </div>
                                            </div>
                                            <div class="space-y-1">
                                                <p class="text-xs opacity-75 font-semibold mb-2 flex items-center">
                                                    <i class="fas fa-users mr-1"></i>
                                                    Por Asesor:
                                                </p>
                                                <div id="dashboard-month-2-asesores" class="max-h-32 overflow-y-auto scrollbar-thin">
                                                    <!-- Asesores will be inserted here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráfico de barras - Montos por Asesor -->
                                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-chart-column mr-2 text-indigo-600"></i>
                                        Montos Aprobados por Asesor
                                    </h3>
                                    <div id="asesores-chart" class="space-y-3">
                                        <!-- Chart items will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gestión de Cartera -->
                    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6">
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-wallet mr-3"></i>
                                Gestión de Cartera
                            </h2>
                            <p class="text-indigo-100 mt-2">Cartera de créditos según tu perfil</p>
                        </div>

                        <!-- Filters & Stats -->
                        <div class="p-6 bg-gray-50 border-b">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600">Total Créditos</p>
                                            <p class="text-2xl font-bold text-indigo-600" id="total-creditos">0</p>
                                        </div>
                                        <i class="fas fa-file-invoice-dollar text-3xl text-indigo-200"></i>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600">Monto Total Aprobado</p>
                                            <p class="text-2xl font-bold text-green-600" id="monto-total">$0</p>
                                        </div>
                                        <i class="fas fa-dollar-sign text-3xl text-green-200"></i>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600">Usuario Actual</p>
                                            <p class="text-lg font-semibold text-gray-700" id="current-user-email">Cargando...</p>
                                        </div>
                                        <i class="fas fa-user text-3xl text-gray-200"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Search -->
                            <div class="flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <input type="text" id="search-creditos" placeholder="Buscar en cartera: nombre, cédula, acta..." 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                                <button onclick="loadCreditos()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center justify-center">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Actualizar
                                </button>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100 border-b-2 border-gray-300">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Acta</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Socio</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Cédula</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Monto</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Interés</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Plazo</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Asesor</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="creditos-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Loading state -->
                                    <tr>
                                        <td colspan="9" class="px-4 py-8 text-center">
                                            <i class="fas fa-spinner fa-spin text-3xl text-indigo-600 mb-2"></i>
                                            <p class="text-gray-600">Cargando créditos...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin Vista General -->
        </div>
    </div>
</div>

        <div id="tab5" class="tab-content hidden">
            <div class="bg-gray-50 min-h-screen">
                <div class="p-6">
                    <iframe src="authform.html" width="100%" height="800" frameborder="0"></iframe>
                </div>
            </div>
        </div>

        <div id="tab6" class="tab-content hidden">
            <div class="bg-gray-50 min-h-screen">
                <div class="p-6">
                    <iframe src="cargacomite.html" width="100%" height="800" frameborder="0"></iframe>
                </div>
            </div>
        </div>

        <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <i id="alertIcon" class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 id="alertTitle" class="text-lg font-semibold text-gray-900">Confirmar Acción</h3>
                        </div>
                    </div>
                    <div class="mb-6">
                        <p id="alertMessage" class="text-sm text-gray-600">¿Estás seguro que deseas continuar?</p>
                    </div>
                    <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                        <button id="alertCancelBtn" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button id="alertConfirmBtn" class="w-full sm:w-auto px-4 py-2 bg-brand-orange hover:bg-orange-600 text-white rounded-lg text-sm font-medium transition-colors">
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-brand-dark-blue text-white py-4 px-6">
            <div class="max-w-7xl mx-auto text-center">
                <p class="text-sm text-gray-300">© 2025 Caja de Ahorro y Crédito Tupak Rantina</p>
            </div>
        </footer>
    </div>

    <script>
        // Tab switching function
        function switchTab(tabIndex, tabTitle = null) {
            // En móvil, evitar acceso a pestaña de Imprimibles
            if (window.innerWidth < 768 && tabIndex === 3) {
                return;
            }
            
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            const mobileButtons = document.querySelectorAll('.mobile-tab-button');
            const currentTabTitle = document.getElementById('current-tab-title');
            const mobileMenu = document.getElementById('mobile-menu');
            
            // Cambiar contenido de las pestañas
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                    tab.classList.remove('hidden');
                    // Scroll al inicio de la pestaña
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 0);
                } else {
                    tab.classList.remove('active');
                    tab.classList.add('hidden');
                }
            });
            
            // Actualizar botones de desktop
            buttons.forEach((button, index) => {
                if (index === tabIndex) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Actualizar botones de móvil
            mobileButtons.forEach((button, index) => {
                if (index === tabIndex) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Actualizar título en móvil y cerrar menú
            if (currentTabTitle) {
                // Definir títulos según el índice
                const titles = ['Calculadora', 'Herramientas de Consulta', 'Documentación', 'Imprimibles', 'Cartera', 'Autorización Exterior', 'Cargar Comité'];
                currentTabTitle.textContent = tabTitle || titles[tabIndex];
            }
            // Siempre cerrar menú móvil al seleccionar una opción
            if (window.innerWidth < 768 && mobileMenu) {
                mobileMenu.classList.add('hidden');
            }

            // Load creditos when switching to creditos tab (index 4)
            if (tabIndex === 4) {
                setTimeout(() => {
                    // Cargar vista general si no se ha cargado
                    if (typeof loadCreditos === 'function' && !window.creditosLoaded) {
                        loadCreditos();
                        window.creditosLoaded = true;
                    }
                    
                    // Verificar atrasados y ajustar switch (solo la primera vez)
                    if (typeof checkAndAdjustCarteraSwitch === 'function' && !window.carteraSwitchAdjusted) {
                        checkAndAdjustCarteraSwitch();
                        window.carteraSwitchAdjusted = true;
                    }
                }, 100);
            }
        }

        // Funcionalidad del menú hamburguesa
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('hidden');
                });
                // Cerrar menú al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }
            
            // Manejar cambios de tamaño de pantalla
            window.addEventListener('resize', function() {
                const tab3 = document.getElementById('tab3');
                if (window.innerWidth < 768) {
                    // En móvil, ocultar Imprimibles
                    tab3.classList.add('hidden');
                    tab3.classList.remove('flex');
                    // Si estaba activa la pestaña 3, cambiar a la 0
                    if (tab3.classList.contains('active')) {
                        switchTab(0, 'Calculadora');
                    }
                } else {
                    // En desktop, mostrar Imprimibles
                    tab3.classList.remove('hidden');
                    tab3.classList.add('flex');
                }
            });
        });

        // --- DOM Element References ---
        const netAmountInput = document.getElementById('netAmount');
        const creditProductInput = document.getElementById('creditProduct');
        const termMonthsInput = document.getElementById('termMonths');
        const patrimonialPercentageInput = document.getElementById('patrimonialPercentage');
        const solcaPercentageInput = document.getElementById('solcaPercentage');
        const autoseguroPercentageInput = document.getElementById('autoseguroPercentage');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultsSection = document.getElementById('resultsSection');
        const amortizationSection = document.getElementById('amortizationSection');

        // Summary elements
        const summaryProductName = document.getElementById('summaryProductName');
        const summaryNetAmount = document.getElementById('summaryNetAmount');
        const summaryPatrimonialAmount = document.getElementById('summaryPatrimonialAmount');
        const summaryTotalCredit = document.getElementById('summaryTotalCredit');
        const summaryNetDisbursement = document.getElementById('summaryNetDisbursement');
        const summaryBasePayment = document.getElementById('summaryBasePayment');
        const summarySolcaAmount = document.getElementById('summarySolcaAmount');
        const summaryAutoseguroAmount = document.getElementById('summaryAutoseguroAmount');
        const summaryTotalToPay = document.getElementById('summaryTotalToPay');
        const financingTypeDisplay = document.getElementById('financingTypeDisplay');
        const monthlyRateDisplay = document.getElementById('monthlyRateDisplay');
        const totalSolcaDisplay = document.getElementById('totalSolcaDisplay');
        const totalAutoseguroDisplay = document.getElementById('totalAutoseguroDisplay');
        const totalInterestDisplay = document.getElementById('totalInterestDisplay');
        const termDisplay = document.getElementById('termDisplay');
        const amortizationTableBody = document.getElementById('amortizationTableBody');
        const amortizationTableHeader = document.getElementById('amortizationTableHeader');

        // --- Utility Functions ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatPercentage(rate) {
            return (rate * 100).toFixed(2) + '%';
        }

        // --- Helper Functions ---
        function calculateFirstPaymentDate(paymentDay) {
            const today = new Date();
            const currentDay = today.getDate();
            const selectedDay = parseInt(paymentDay);
            
            let targetMonth = today.getMonth();
            let targetYear = today.getFullYear();
            
            // Lógica basada en los ejemplos del sistema de la caja:
            // Si el día seleccionado es menor que el día actual
            if (selectedDay < currentDay) {
                const daysBack = currentDay - selectedDay;
                // Si la diferencia es mayor a 7 días, ir al siguiente mes del próximo
                if (daysBack > 7) {
                    targetMonth += 2; // Saltar 2 meses
                } else {
                    targetMonth += 1; // Ir al siguiente mes
                }
            } else {
                // Si es el mismo día o un día futuro, ir al siguiente mes
                targetMonth += 1;
            }
            
            // Manejar cambio de año
            while (targetMonth > 11) {
                targetMonth -= 12;
                targetYear++;
            }
            
            // Crear la fecha objetivo
            let firstPaymentDate = new Date(targetYear, targetMonth, selectedDay);
            
            // Si el día no existe en ese mes (ej: 31 en febrero), ajustar al último día del mes
            if (firstPaymentDate.getMonth() !== targetMonth) {
                firstPaymentDate = new Date(targetYear, targetMonth + 1, 0); // Último día del mes anterior
            }
            
            return firstPaymentDate;
        }

        // --- Main Calculation Function ---
        function calculateLoan() {
            // Get input values
            const netAmount = parseFloat(netAmountInput.value) || 0;
            const annualRate = parseFloat(creditProductInput.value) || 0;
            const termMonths = parseInt(termMonthsInput.value) || 0;
            const patrimonialPercentage = parseFloat(patrimonialPercentageInput.value) || 0;
            const solcaPercentage = parseFloat(solcaPercentageInput.value) || 0;
            const autoseguroPercentage = parseFloat(autoseguroPercentageInput.value) || 0;
            const paymentDay = new Date().getDate(); // Siempre usar el día actual
            
            // Get financing type
            const financingType = document.querySelector('input[name="financingType"]:checked').value;

            // Validate inputs
            if (netAmount <= 0 || annualRate <= 0 || termMonths <= 0) {
                alert('Por favor, ingrese valores válidos para todos los campos.');
                return;
            }

            if (patrimonialPercentage < 0 || patrimonialPercentage >= 100) {
                alert('El porcentaje del aporte patrimonial debe estar entre 0 y 99.99%');
                return;
            }

            // Calcular la fecha de primer pago basada en el día seleccionado
            const firstPaymentDate = calculateFirstPaymentDate(paymentDay);
            const today = new Date();
            
            // Calcular la duración real del préstamo en días
            const lastPaymentDate = new Date(firstPaymentDate);
            lastPaymentDate.setMonth(lastPaymentDate.getMonth() + termMonths - 1);
            const totalDays = Math.ceil((lastPaymentDate - today) / (1000 * 60 * 60 * 24));
            
            // Días estándar (30 días por mes)
            const standardDays = termMonths * 30;
            
            // Factor de ajuste basado en la duración real vs estándar
            const durationFactor = totalDays / standardDays;
            
            // Calculate monthly interest rate ajustado por la duración real
            const baseMonthlyRate = annualRate / 100 / 12;
            const adjustedMonthlyRate = baseMonthlyRate * durationFactor;

            let totalCredit, netDisbursement, patrimonialAmount;

            if (financingType === 'finance') {
                // Option 2: Finance the patrimonial contribution
                // Total credit = Net Amount / (1 - Patrimonial Percentage)
                totalCredit = netAmount / (1 - patrimonialPercentage / 100);
                patrimonialAmount = totalCredit * (patrimonialPercentage / 100);
                netDisbursement = netAmount; // Client receives exactly what they asked for
            } else {
                // Option 1: Discount from credit
                totalCredit = netAmount;
                patrimonialAmount = totalCredit * (patrimonialPercentage / 100);
                netDisbursement = totalCredit - patrimonialAmount;
            }

            // Calculate SOLCA and Autoseguro amounts (se cobran al desembolso)
            const totalSolca = totalCredit * (solcaPercentage / 100);
            const totalAutoseguro = totalCredit * (autoseguroPercentage / 100);
            
            // Descontar SOLCA y Autoseguro del desembolso neto
            netDisbursement = netDisbursement - totalSolca - totalAutoseguro;

            // Calculate base monthly payment using adjusted rate
            // PMT = P * [r(1+r)^n] / [(1+r)^n - 1]
            const baseMonthlyPayment = totalCredit * (adjustedMonthlyRate * Math.pow(1 + adjustedMonthlyRate, termMonths)) / 
                                      (Math.pow(1 + adjustedMonthlyRate, termMonths) - 1);

            // La cuota mensual total es solo la cuota base (SOLCA y Autoseguro ya se cobraron)
            const totalMonthlyPayment = baseMonthlyPayment;

            const baseTotalToPay = baseMonthlyPayment * termMonths;
            const grandTotalToPay = totalMonthlyPayment * termMonths;
            const totalInterest = baseTotalToPay - totalCredit;

            // Get product name from selected option
            const selectedOption = creditProductInput.options[creditProductInput.selectedIndex];
            const productName = selectedOption.textContent;

            // Update summary display
            summaryProductName.textContent = productName;
            summaryNetAmount.textContent = formatCurrency(netAmount);
            summaryPatrimonialAmount.textContent = formatCurrency(patrimonialAmount);
            summaryTotalCredit.textContent = formatCurrency(totalCredit);
            summaryNetDisbursement.textContent = formatCurrency(netDisbursement);
            summaryBasePayment.textContent = formatCurrency(baseMonthlyPayment);
            summarySolcaAmount.textContent = formatCurrency(totalSolca);
            summaryAutoseguroAmount.textContent = formatCurrency(totalAutoseguro);
            summaryTotalToPay.textContent = formatCurrency(grandTotalToPay);

            // Update additional info
            financingTypeDisplay.textContent = financingType === 'finance' ? 
                'Financiamiento del aporte' : 'Descuento del crédito';
            monthlyRateDisplay.textContent = formatPercentage(adjustedMonthlyRate);
            totalSolcaDisplay.textContent = formatCurrency(totalSolca);
            totalAutoseguroDisplay.textContent = formatCurrency(totalAutoseguro);
            totalInterestDisplay.textContent = formatCurrency(totalInterest);
            termDisplay.textContent = `${termMonths} meses`;

            // Debug: Show calculated values in console
            console.log('Debug - Calculation details:');
            console.log('Payment day:', paymentDay);
            console.log('Total days:', totalDays);
            console.log('Duration factor:', durationFactor.toFixed(6));
            console.log('Base monthly rate:', (baseMonthlyRate * 100).toFixed(4) + '%');
            console.log('Adjusted monthly rate:', (adjustedMonthlyRate * 100).toFixed(4) + '%');
            console.log('Base monthly payment:', baseMonthlyPayment.toFixed(2));

            // Generate amortization table
            generateAmortizationTable(totalCredit, adjustedMonthlyRate, termMonths, baseMonthlyPayment, totalSolca, totalAutoseguro, firstPaymentDate);

            // Show results sections
            resultsSection.style.display = 'grid';
            amortizationSection.style.display = 'block';

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Amortization Table Generation ---
        function generateAmortizationTable(principal, monthlyRate, termMonths, baseMonthlyPayment, totalSolca, totalAutoseguro, firstPaymentDate = null) {
            let balance = principal;
            let tableHTML = '';
            
            // Actualizar header de la tabla basado en si hay fecha
            const hasPaymentDate = firstPaymentDate !== null;
            let headerHTML = `
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuota</th>
                ${hasPaymentDate ? '<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Pago</th>' : ''}
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Inicial</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuota Base</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interés</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capital</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SOLCA</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Autoseguro</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuota Total</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Final</th>
            `;
            amortizationTableHeader.innerHTML = headerHTML;

            // Usar la fecha de primer pago proporcionada
            let currentPaymentDate = firstPaymentDate ? new Date(firstPaymentDate) : null;

            for (let month = 1; month <= termMonths; month++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = baseMonthlyPayment - interestPayment;
                const newBalance = balance - principalPayment;

                // Handle final payment rounding
                const finalPrincipalPayment = month === termMonths ? balance : principalPayment;
                const finalBalance = month === termMonths ? 0 : newBalance;
                const finalInterestPayment = month === termMonths ? balance * monthlyRate : interestPayment;
                const finalTotalPayment = finalInterestPayment + finalPrincipalPayment;

                // Calcular fecha de pago para esta cuota
                let paymentDateStr = '';
                if (currentPaymentDate) {
                    // Formatear fecha como dd-mm-yyyy
                    const day = String(currentPaymentDate.getDate()).padStart(2, '0');
                    const month = String(currentPaymentDate.getMonth() + 1).padStart(2, '0');
                    const year = currentPaymentDate.getFullYear();
                    paymentDateStr = `${day}-${month}-${year}`;
                    
                    // Avanzar al siguiente mes
                    currentPaymentDate.setMonth(currentPaymentDate.getMonth() + 1);
                }

                tableHTML += `
                    <tr class="${month % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="px-2 py-2 text-sm text-gray-900">${month}</td>
                        ${paymentDateStr ? `<td class="px-2 py-2 text-sm text-gray-700">${paymentDateStr}</td>` : ''}
                        <td class="px-2 py-2 text-sm text-gray-900">${formatCurrency(balance)}</td>
                        <td class="px-2 py-2 text-sm text-gray-700">${formatCurrency(finalTotalPayment)}</td>
                        <td class="px-2 py-2 text-sm text-red-600">${formatCurrency(finalInterestPayment)}</td>
                        <td class="px-2 py-2 text-sm text-green-600">${formatCurrency(finalPrincipalPayment)}</td>
                        <td class="px-2 py-2 text-sm text-purple-600">$0.00</td>
                        <td class="px-2 py-2 text-sm text-indigo-600">$0.00</td>
                        <td class="px-2 py-2 text-sm font-medium text-brand-orange">${formatCurrency(finalTotalPayment)}</td>
                        <td class="px-2 py-2 text-sm text-gray-900">${formatCurrency(finalBalance)}</td>
                    </tr>
                `;

                balance = finalBalance;
            }

            amortizationTableBody.innerHTML = tableHTML;
        }

        // --- Auto Cache and Clear Functions ---
        function autoCacheCurrentValues() {
            const formData = {
                netAmount: netAmountInput.value,
                creditProduct: creditProductInput.value,
                termMonths: termMonthsInput.value,
                patrimonialPercentage: patrimonialPercentageInput.value,
                financingType: document.querySelector('input[name="financingType"]:checked').value
            };
            
            localStorage.setItem('calculatorCache', JSON.stringify(formData));
        }

        function loadCachedValues() {
            const cached = localStorage.getItem('calculatorCache');
            if (cached) {
                const formData = JSON.parse(cached);
                
                netAmountInput.value = formData.netAmount || '';
                creditProductInput.value = formData.creditProduct || '26';
                termMonthsInput.value = formData.termMonths || '';
                patrimonialPercentageInput.value = formData.patrimonialPercentage || '2.75';
                
                // Set financing type
                const financingRadio = document.querySelector(`input[name="financingType"][value="${formData.financingType || 'discount'}"]`);
                if (financingRadio) {
                    financingRadio.checked = true;
                }
            }
        }

        function clearForm() {
            // Reset to default values
            netAmountInput.value = '';
            creditProductInput.value = '26'; // Microcrédito Minorista por defecto
            termMonthsInput.value = '';
            patrimonialPercentageInput.value = '2.75'; // Por defecto 2.75%
            solcaPercentageInput.value = '0.05'; // Fijo
            autoseguroPercentageInput.value = '0.72'; // Fijo
            
            // Reset financing type to "Descontar"
            document.querySelector('input[name="financingType"][value="discount"]').checked = true;
            
            // Hide results
            resultsSection.style.display = 'none';
            amortizationSection.style.display = 'none';
            
            // Auto cache after clearing
            autoCacheCurrentValues();
        }

        // --- Event Listeners ---
        generateBtn.addEventListener('click', calculateLoan);
        clearBtn.addEventListener('click', clearForm);

        // Allow pressing Enter to calculate
        [netAmountInput, termMonthsInput].forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateLoan();
                }
            });
        });

        // Auto-cache cuando cambien los inputs (pero NO recalcular automáticamente)
        [netAmountInput, termMonthsInput].forEach(input => {
            input.addEventListener('input', function() {
                autoCacheCurrentValues(); // Solo guardar cache, no recalcular
            });
        });

        // Initialize form with defaults or cached values
        function initializeForm() {
            // Try to load cached values first
            loadCachedValues();
            
            // If no cached values, set defaults
            if (!localStorage.getItem('calculatorCache')) {
                clearForm(); // This sets all the default values
            }
        }

        // Initialize on page load
        initializeForm();

        // Recalculate when any select changes (solo para dropdowns, no inputs)
        [creditProductInput, patrimonialPercentageInput].forEach(select => {
            select.addEventListener('change', function() {
                autoCacheCurrentValues(); // Auto-cache on change
                if (resultsSection.style.display !== 'none') {
                    calculateLoan(); // Recalculate if results are already showing
                }
            });
        });

        // Radio button change handler
        document.querySelectorAll('input[name="financingType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                autoCacheCurrentValues(); // Auto-cache on change
                if (resultsSection.style.display !== 'none') {
                    calculateLoan(); // Recalculate if results are already showing
                }
            });
        });

        // --- Custom Alert Modal ---
        class CustomAlert {
            constructor() {
                this.modal = document.getElementById('customAlertModal');
                this.alertIcon = document.getElementById('alertIcon');
                this.alertTitle = document.getElementById('alertTitle');
                this.alertMessage = document.getElementById('alertMessage');
                this.confirmBtn = document.getElementById('alertConfirmBtn');
                this.cancelBtn = document.getElementById('alertCancelBtn');
                
                this.init();
            }

            init() {
                // Close modal when clicking outside or pressing Escape
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) {
                        this.hide();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) {
                        this.hide();
                    }
                });

                this.cancelBtn.addEventListener('click', () => {
                    this.hide();
                });
            }

            show(options = {}) {
                const {
                    title = 'Confirmar Acción',
                    message = '¿Estás seguro que deseas continuar?',
                    confirmText = 'Confirmar',
                    cancelText = 'Cancelar',
                    icon = 'fas fa-exclamation-triangle text-yellow-500',
                    onConfirm = null
                } = options;

                this.alertTitle.textContent = title;
                this.alertMessage.textContent = message;
                this.confirmBtn.textContent = confirmText;
                this.cancelBtn.textContent = cancelText;
                this.alertIcon.className = `${icon} text-2xl`;

                // Remove any existing event listeners
                this.confirmBtn.replaceWith(this.confirmBtn.cloneNode(true));
                this.confirmBtn = document.getElementById('alertConfirmBtn');

                // Add new event listener
                this.confirmBtn.addEventListener('click', () => {
                    this.hide();
                    if (onConfirm && typeof onConfirm === 'function') {
                        onConfirm();
                    }
                });

                this.modal.classList.remove('hidden');
                this.confirmBtn.focus();
            }

            hide() {
                this.modal.classList.add('hidden');
            }
        }

        // --- Checklist Management ---
        class DocumentChecklistManager {
            constructor() {
                this.storageKey = 'documentChecklist';
                this.timestampKey = 'documentChecklistTimestamp';
                this.resetPeriod = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
                this.init();
            }

            init() {
                this.checkExpiration();
                this.loadChecklistState();
                this.attachEventListeners();
                this.updateCounters();
                this.updateLastResetDisplay();
            }

            checkExpiration() {
                const timestamp = localStorage.getItem(this.timestampKey);
                if (timestamp) {
                    const lastReset = new Date(parseInt(timestamp));
                    const now = new Date();
                    const timeDiff = now.getTime() - lastReset.getTime();
                    
                    if (timeDiff > this.resetPeriod) {
                        this.resetChecklist();
                        return;
                    }
                }
                
                // If no timestamp exists, create one
                if (!timestamp) {
                    localStorage.setItem(this.timestampKey, Date.now().toString());
                }
            }

            loadChecklistState() {
                const savedState = localStorage.getItem(this.storageKey);
                if (savedState) {
                    const checkedItems = JSON.parse(savedState);
                    checkedItems.forEach(docId => {
                        const checkbox = document.getElementById(`doc${docId}`);
                        if (checkbox) {
                            checkbox.checked = true;
                            this.updateRowStyle(checkbox, true);
                        }
                    });
                }
            }

            saveChecklistState() {
                const checkboxes = document.querySelectorAll('.document-checkbox');
                const checkedItems = [];
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const docId = checkbox.getAttribute('data-doc');
                        checkedItems.push(docId);
                    }
                });
                
                localStorage.setItem(this.storageKey, JSON.stringify(checkedItems));
            }

            resetChecklist() {
                localStorage.removeItem(this.storageKey);
                localStorage.setItem(this.timestampKey, Date.now().toString());
                
                const checkboxes = document.querySelectorAll('.document-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    this.updateRowStyle(checkbox, false);
                });
                
                this.updateCounters();
                this.updateLastResetDisplay();
                this.showResetNotification();
            }

            updateRowStyle(checkbox, isChecked) {
                const row = checkbox.closest('.p-4');
                const label = row.querySelector('label');
                
                if (isChecked) {
                    row.classList.add('bg-green-50');
                    label.classList.add('line-through', 'opacity-75');
                } else {
                    row.classList.remove('bg-green-50');
                    label.classList.remove('line-through', 'opacity-75');
                }
            }

            updateCounters() {
                const checkboxes = document.querySelectorAll('.document-checkbox');
                const totalCount = checkboxes.length;
                const completedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                
                document.getElementById('completedCount').textContent = completedCount;
                document.getElementById('totalCount').textContent = totalCount;
            }

            updateLastResetDisplay() {
                const timestamp = localStorage.getItem(this.timestampKey);
                const statusElement = document.getElementById('checklistStatus');
                
                if (timestamp) {
                    const lastReset = new Date(parseInt(timestamp));
                    const now = new Date();
                    const daysAgo = Math.floor((now.getTime() - lastReset.getTime()) / (24 * 60 * 60 * 1000));
                    const daysRemaining = Math.max(0, 7 - daysAgo);
                    
                    if (daysRemaining > 0) {
                        statusElement.innerHTML = `
                            <i class="fas fa-clock mr-2"></i>
                            Checklist se reinicia en ${daysRemaining} día${daysRemaining !== 1 ? 's' : ''}
                        `;
                    } else {
                        statusElement.innerHTML = `
                            <i class="fas fa-exclamation-triangle mr-2 text-orange-500"></i>
                            <span class="text-orange-600">Checklist listo para reiniciar</span>
                        `;
                    }
                } else {
                    statusElement.innerHTML = `
                        <i class="fas fa-clock mr-2"></i>
                        Checklist se reinicia automáticamente cada 7 días
                    `;
                }
            }

            showResetNotification() {
                // Create a temporary notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>Checklist reiniciado correctamente</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Animate out and remove
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            attachEventListeners() {
                // Checkbox change listeners
                const checkboxes = document.querySelectorAll('.document-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        this.updateRowStyle(e.target, e.target.checked);
                        this.saveChecklistState();
                        this.updateCounters();
                    });
                });

                // Reset button listener
                const resetButton = document.getElementById('resetChecklistBtn');
                if (resetButton) {
                    resetButton.addEventListener('click', () => {
                        if (!window.customAlert) {
                            window.customAlert = new CustomAlert();
                        }
                        
                        window.customAlert.show({
                            title: 'Reiniciar Checklist',
                            message: '¿Estás seguro que deseas reiniciar el checklist? Se perderá todo el progreso actual.',
                            confirmText: 'Sí, Reiniciar',
                            cancelText: 'Cancelar',
                            icon: 'fas fa-refresh text-orange-500',
                            onConfirm: () => {
                                this.resetChecklist();
                            }
                        });
                    });
                }
            }
        }

        // Initialize checklist manager when on the documentation tab
        let checklistManager = null;
        
        // Override the switchTab function to initialize checklist on documentation tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabIndex) {
            originalSwitchTab(tabIndex);
            
            // Initialize checklist manager when switching to documentation tab (index 2)
            if (tabIndex === 2 && !checklistManager) {
                setTimeout(() => {
                    checklistManager = new DocumentChecklistManager();
                }, 100);
            }
        };

        // --- Initialize MathJax when loaded ---
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };

        // ===== GESTIÓN DE CARTERA =====
        let creditosData = [];
        let carteraDataCache = null; // Cache para todos los créditos
        let filteredCreditos = [];
        let hasCarteraAccess = false;
        let currentCarteraView = 'cobros'; // 'atrasados', 'cobros' o 'general' (por defecto: cobros)
        let hasAtrasados = false; // Flag para saber si hay créditos atrasados

        // Función para verificar si hay atrasados y ajustar el switch
        async function checkAndAdjustCarteraSwitch() {
            try {
                const carteraData = await loadAllCarteraData();
                
                // Contar créditos atrasados
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                const atrasadosCount = (carteraData.data || []).filter(credito => {
                    const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
                    if (!credito.dia_pago || !mesAnioPrimerPago) return false;
                    
                    const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
                    const plazo = parseInt(credito.plazo) || 0;
                    
                    if (plazo > 0 && cuotaPagada >= plazo) return false;
                    
                    const diasRestantes = diasHastaFecha(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                    return diasRestantes !== null && diasRestantes < 0;
                }).length;
                
                hasAtrasados = atrasadosCount > 0;
                
                // Ajustar UI del switch
                const btnAtrasados = document.getElementById('btn-atrasados');
                const btnCobros = document.getElementById('btn-cobros');
                const btnGeneral = document.getElementById('btn-general');
                const slider = document.getElementById('switch-slider');
                
                // Ocultar loading y mostrar switch primero
                const loadingElement = document.getElementById('cartera-switch-loading');
                const switchContainer = document.getElementById('cartera-switch-container');
                
                if (loadingElement) loadingElement.classList.add('hidden');
                if (switchContainer) switchContainer.classList.remove('hidden');
                
                if (!hasAtrasados) {
                    // Ocultar botón de atrasados
                    if (btnAtrasados) btnAtrasados.classList.add('hidden');
                    
                    // Ajustar ancho del slider para 2 botones (50%)
                    if (slider) {
                        slider.style.width = 'calc(50% - 4px)';
                    }
                    
                    // Cargar vista de cobros por defecto
                    currentCarteraView = 'cobros';
                    setCarteraView('cobros');
                } else {
                    // Mostrar botón de atrasados
                    if (btnAtrasados) btnAtrasados.classList.remove('hidden');
                    
                    // Ajustar ancho del slider para 3 botones (33.333%)
                    if (slider) {
                        slider.style.width = 'calc(33.333% - 4px)';
                    }
                    
                    // Cargar vista de atrasados por defecto
                    currentCarteraView = 'atrasados';
                    setCarteraView('atrasados');
                }
                
            } catch (error) {
                console.error('Error al verificar atrasados:', error);
                
                // En caso de error, mostrar switch con mensaje de error
                const loadingElement = document.getElementById('cartera-switch-loading');
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div class="flex items-center justify-center gap-3">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                            <p class="text-red-600 font-medium">Error al cargar cartera</p>
                        </div>
                    `;
                }
            }
        }

        // Función para cambiar entre vistas de cartera
        function setCarteraView(view) {
            const generalView = document.getElementById('cartera-view-general');
            const cobrosView = document.getElementById('cartera-view-cobros');
            const atrasadosView = document.getElementById('cartera-view-atrasados');
            const btnGeneral = document.getElementById('btn-general');
            const btnCobros = document.getElementById('btn-cobros');
            const btnAtrasados = document.getElementById('btn-atrasados');
            const slider = document.getElementById('switch-slider');
            
            currentCarteraView = view;
            
            // Ocultar todas las vistas
            generalView.classList.add('hidden');
            cobrosView.classList.add('hidden');
            atrasadosView.classList.add('hidden');
            
            // Reset estilos de todos los botones
            [btnAtrasados, btnCobros, btnGeneral].forEach(btn => {
                btn.classList.remove('text-white', 'font-semibold');
                btn.classList.add('text-gray-600', 'font-medium', 'hover:text-gray-800');
            });
            
            if (view === 'atrasados') {
                // Mostrar vista Atrasados
                atrasadosView.classList.remove('hidden');
                
                // Mover slider a la izquierda (posición 1)
                slider.style.transform = 'translateX(0)';
                slider.className = 'absolute top-1 left-1 h-[calc(100%-8px)] w-[calc(33.333%-4px)] bg-gradient-to-r from-red-500 to-red-600 rounded-md shadow-md transition-transform duration-300 ease-in-out';
                
                // Actualizar botón activo
                btnAtrasados.classList.remove('text-gray-600', 'font-medium', 'hover:text-gray-800');
                btnAtrasados.classList.add('text-white', 'font-semibold');
                
                // Cargar atrasados cuando se cambia a esta vista
                if (!window.atrasadosLoaded) {
                    loadAtrasados();
                    window.atrasadosLoaded = true;
                }
                
            } else if (view === 'cobros') {
                // Mostrar vista Cobros Próximos
                cobrosView.classList.remove('hidden');
                
                // Posición del slider depende si hay atrasados o no
                if (hasAtrasados) {
                    // Con 3 botones: cobros está en el centro
                    slider.style.transform = 'translateX(calc(100% + 4px))';
                    slider.style.width = 'calc(33.333% - 4px)';
                } else {
                    // Con 2 botones: cobros está a la izquierda
                    slider.style.transform = 'translateX(0)';
                    slider.style.width = 'calc(50% - 4px)';
                }
                slider.className = 'absolute top-1 left-1 h-[calc(100%-8px)] bg-gradient-to-r from-orange-500 to-orange-600 rounded-md shadow-md transition-transform duration-300 ease-in-out';
                
                // Actualizar botón activo
                btnCobros.classList.remove('text-gray-600', 'font-medium', 'hover:text-gray-800');
                btnCobros.classList.add('text-white', 'font-semibold');
                
                // Cargar cobros próximos cuando se cambia a esta vista
                if (!window.cobrosProximosLoaded) {
                    loadCobrosProximos();
                    window.cobrosProximosLoaded = true;
                }
                
            } else if (view === 'general') {
                // Mostrar vista General
                generalView.classList.remove('hidden');
                
                // Posición del slider depende si hay atrasados o no
                if (hasAtrasados) {
                    // Con 3 botones: general está a la derecha
                    slider.style.transform = 'translateX(calc(200% + 8px))';
                    slider.style.width = 'calc(33.333% - 4px)';
                } else {
                    // Con 2 botones: general está a la derecha
                    slider.style.transform = 'translateX(calc(100% + 4px))';
                    slider.style.width = 'calc(50% - 4px)';
                }
                slider.className = 'absolute top-1 left-1 h-[calc(100%-8px)] bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-md shadow-md transition-transform duration-300 ease-in-out';
                
                // Actualizar botón activo
                btnGeneral.classList.remove('text-gray-600', 'font-medium', 'hover:text-gray-800');
                btnGeneral.classList.add('text-white', 'font-semibold');
            }
        }

        // Función para calcular días restantes hasta una fecha
        function diasHastaFecha(diaPago, mesAnioPrimerPago, cuotaPagada = 0) {
            if (!diaPago || !mesAnioPrimerPago) return null;
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            try {
                // Parsear mes_anio_primer_pago (formato esperado: "10/2025" o "MM/YYYY")
                const partes = mesAnioPrimerPago.split('/');
                if (partes.length !== 2) return null;
                
                const mesPrimerPago = parseInt(partes[0]); // 1-12
                const anioPrimerPago = parseInt(partes[1]); // ej: 2025
                
                if (isNaN(mesPrimerPago) || isNaN(anioPrimerPago)) return null;
                if (mesPrimerPago < 1 || mesPrimerPago > 12) return null;
                
                // Crear fecha del primer pago
                const primerPago = new Date(anioPrimerPago, mesPrimerPago - 1, parseInt(diaPago));
                primerPago.setHours(0, 0, 0, 0);
                
                // Calcular fecha del próximo pago sumando las cuotas pagadas
                const proximoPago = new Date(primerPago);
                proximoPago.setMonth(primerPago.getMonth() + cuotaPagada);
                
                // Calcular diferencia en días (puede ser negativa si ya pasó)
                const diferencia = Math.ceil((proximoPago - hoy) / (1000 * 60 * 60 * 24));
                return diferencia;
                
            } catch (error) {
                console.error('Error al calcular días hasta fecha:', error);
                return null;
            }
        }
        
        // Función helper para obtener el valor de mes_anio_primer_pago 
        // (maneja diferentes formas en que puede venir de la BD)
        function getMesAnioPrimerPago(credito) {
            // Intentar diferentes variantes del nombre de columna
            return credito['mes_anio_primer_pago'] || 
                   credito['mes / año_primer_pago'] ||
                   credito.mes_año_primer_pago ||
                   null;
        }
        
        // Función para formatear la fecha del primer pago para mostrar
        function formatearPrimerPago(mesAnioPrimerPago, diaPago) {
            if (!mesAnioPrimerPago || !diaPago) return 'N/A';
            
            try {
                const partes = mesAnioPrimerPago.split('/');
                if (partes.length !== 2) return mesAnioPrimerPago;
                
                const mes = parseInt(partes[0]);
                const anio = parseInt(partes[1]);
                
                if (isNaN(mes) || isNaN(anio)) return mesAnioPrimerPago;
                
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const nombreMes = meses[mes - 1] || mes;
                
                return `${diaPago}/${nombreMes}/${anio}`;
            } catch (error) {
                return mesAnioPrimerPago;
            }
        }

        // Función para obtener badge de urgencia según días restantes
        function getUrgenciaBadge(diasRestantes) {
            if (diasRestantes === 0) {
                return '<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-600 text-white animate-pulse">¡HOY!</span>';
            } else if (diasRestantes === 1) {
                return '<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-500 text-white">Mañana</span>';
            } else if (diasRestantes <= 2) {
                return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-500 text-white">' + diasRestantes + ' días</span>';
            } else {
                return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-500 text-white">' + diasRestantes + ' días</span>';
            }
        }

        // Función centralizada para cargar todos los créditos (una sola vez)
        async function loadAllCarteraData(forceReload = false) {
            // Si ya tenemos datos en cache y no forzamos recarga, retornar cache
            if (carteraDataCache && !forceReload) {
                return carteraDataCache;
            }

            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    throw new Error('No se pudo obtener el usuario actual');
                }

                const userEmail = user.email;

                // Query créditos based on user email
                let query = supabase
                    .from('actas_creditos_tupakra')
                    .select('*')
                    .order('created_at', { ascending: false });

                // If user is NOT contacto@tupakrantina.com, filter by correo_asesor
                const isAdmin = userEmail === 'contacto@tupakrantina.com';
                if (!isAdmin) {
                    query = query.eq('correo_asesor', userEmail);
                }

                const { data, error } = await query;

                if (error) {
                    throw error;
                }

                // Guardar en cache
                carteraDataCache = {
                    data: data || [],
                    userEmail: userEmail,
                    isAdmin: isAdmin,
                    timestamp: Date.now()
                };

                return carteraDataCache;

            } catch (error) {
                console.error('Error al cargar datos de cartera:', error);
                throw error;
            }
        }

        // Función para cargar pagos atrasados
        async function loadAtrasados() {
            try {
                const tableBody = document.getElementById('atrasados-table-body');
                const userEmailElement = document.getElementById('atrasados-user-email');
                
                // Show loading state
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-spinner fa-spin text-3xl text-red-600 mb-2"></i>
                            <p class="text-gray-600">Cargando pagos atrasados...</p>
                        </td>
                    </tr>
                `;

                // Cargar todos los datos (usa cache si ya se cargó)
                const carteraData = await loadAllCarteraData();
                
                if (userEmailElement) {
                    userEmailElement.textContent = carteraData.userEmail;
                }

                // Filtrar solo los que tienen pagos atrasados (días negativos)
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                const atrasados = (carteraData.data || []).filter(credito => {
                    const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
                    if (!credito.dia_pago || !mesAnioPrimerPago) return false;
                    
                    const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
                    const plazo = parseInt(credito.plazo) || 0;
                    
                    // No mostrar si ya completó todas las cuotas
                    if (plazo > 0 && cuotaPagada >= plazo) return false;
                    
                    const diasRestantes = diasHastaFecha(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                    
                    // Solo mostrar si tiene días negativos (ya pasó la fecha)
                    return diasRestantes !== null && diasRestantes < 0;
                });

                // Ordenar por días de retraso (más atrasados primero)
                atrasados.sort((a, b) => {
                    const cuotaPagadaA = parseInt(a.cuota_pagada) || 0;
                    const cuotaPagadaB = parseInt(b.cuota_pagada) || 0;
                    const mesAnioA = getMesAnioPrimerPago(a);
                    const mesAnioB = getMesAnioPrimerPago(b);
                    const diasA = diasHastaFecha(a.dia_pago, mesAnioA, cuotaPagadaA);
                    const diasB = diasHastaFecha(b.dia_pago, mesAnioB, cuotaPagadaB);
                    return diasA - diasB; // Más negativos primero
                });

                // Update stats
                updateAtrasadosStats(atrasados);
                
                // Render table
                renderAtrasadosTable(atrasados);

                // Show success message
                if (window.TupakAuth && window.TupakAuth.showToast) {
                    window.TupakAuth.showToast(`${atrasados.length} pagos atrasados cargados`, 'info');
                }

            } catch (error) {
                console.error('Error al cargar pagos atrasados:', error);
                const tableBody = document.getElementById('atrasados-table-body');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-600 mb-2"></i>
                            <p class="text-red-600">Error al cargar pagos atrasados</p>
                            <p class="text-gray-600 text-sm">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Función para actualizar estadísticas de atrasados
        function updateAtrasadosStats(atrasados) {
            const countElement = document.getElementById('atrasados-count');
            const montoElement = document.getElementById('atrasados-monto-total');
            
            if (countElement) {
                countElement.textContent = atrasados.length;
            }
            
            if (montoElement) {
                const montoTotal = atrasados.reduce((sum, credito) => {
                    return sum + (parseFloat(credito.monto_aprobado) || 0);
                }, 0);
                
                montoElement.textContent = '$' + montoTotal.toLocaleString('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        // Función para renderizar tabla de atrasados
        function renderAtrasadosTable(atrasados) {
            const tableBody = document.getElementById('atrasados-table-body');
            
            if (atrasados.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i>
                            <p class="text-gray-600 font-semibold">¡No hay pagos atrasados!</p>
                            <p class="text-gray-500 text-sm">Todos los pagos están al día</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = atrasados.map(credito => {
                const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
                const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
                const diasRestantes = diasHastaFecha(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                const diasRetraso = Math.abs(diasRestantes); // Convertir a positivo para mostrar
                const fechaVencida = calcularFechaVencida(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                const montoFormateado = parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Badge de retraso según gravedad
                let retrasoBadge;
                if (diasRetraso >= 30) {
                    retrasoBadge = `<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-700 text-white animate-pulse">${diasRetraso} días</span>`;
                } else if (diasRetraso >= 15) {
                    retrasoBadge = `<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-600 text-white">${diasRetraso} días</span>`;
                } else if (diasRetraso >= 7) {
                    retrasoBadge = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-600 text-white">${diasRetraso} días</span>`;
                } else {
                    retrasoBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-500 text-white">${diasRetraso} días</span>`;
                }
                
                // Determinar color de fila según gravedad
                let rowClass = 'hover:bg-gray-50';
                if (diasRetraso >= 30) {
                    rowClass = 'bg-red-100 hover:bg-red-200';
                } else if (diasRetraso >= 15) {
                    rowClass = 'bg-red-50 hover:bg-red-100';
                } else if (diasRetraso >= 7) {
                    rowClass = 'bg-orange-50 hover:bg-orange-100';
                }
                
                return `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-4 py-3 text-sm font-bold text-gray-900">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-calendar-times text-red-600"></i>
                                <span>${fechaVencida}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            ${retrasoBadge}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium text-right">${credito.acta || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${credito.nombre_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 text-right">${credito.cedula_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold text-right">$${montoFormateado}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <a href="tel:${credito.telefono_socio}" class="text-blue-600 hover:text-blue-800 hover:underline">
                                <i class="fas fa-phone mr-1"></i>${credito.telefono_socio || 'N/A'}
                            </a>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600 truncate max-w-xs" title="${credito.asesor_credito || 'N/A'}">${credito.asesor_credito || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex gap-2 flex-wrap justify-center">
                                <button onclick="confirmarEnviarNotificacion(${JSON.stringify(credito).replace(/"/g, '&quot;')})" 
                                        ${!canSendNotifications() ? 'disabled' : ''}
                                        class="group bg-green-500 hover:bg-green-600 text-white px-2 py-2 md:px-3 md:py-1 rounded text-xs font-bold shadow-sm inline-flex items-center ${!canSendNotifications() ? 'opacity-50 cursor-not-allowed' : ''}"
                                        title="Enviar recordatorio por WhatsApp">
                                    <i class="fab fa-whatsapp flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Notificar</span>
                                </button>
                                <button onclick="confirmarMarcarPagado(${JSON.stringify(credito).replace(/"/g, '&quot;')})" 
                                        ${isAdminUser() ? 'disabled' : ''}
                                        class="group bg-blue-500 hover:bg-blue-600 text-white px-2 py-2 md:px-3 md:py-1 rounded text-xs font-bold shadow-sm inline-flex items-center ${isAdminUser() ? 'opacity-50 cursor-not-allowed' : ''}"
                                        title="${isAdminUser() ? 'Solo los asesores pueden marcar como pagado' : 'Marcar cuota como pagada'}">
                                    <i class="fas fa-check-circle flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Pagado</span>
                                </button>
                                <button onclick="viewCreditoDetails(${credito.id})" 
                                        class="group bg-red-100 hover:bg-red-200 text-red-700 px-2 py-2 md:px-3 md:py-1 rounded text-xs font-medium">
                                    <i class="fas fa-eye flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Ver</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        // Función para calcular la fecha vencida
        function calcularFechaVencida(diaPago, mesAnioPrimerPago, cuotaPagada = 0) {
            if (!diaPago || !mesAnioPrimerPago) return 'N/A';
            
            try {
                const partes = mesAnioPrimerPago.split('/');
                if (partes.length !== 2) return 'N/A';
                
                const mesPrimerPago = parseInt(partes[0]);
                const anioPrimerPago = parseInt(partes[1]);
                
                if (isNaN(mesPrimerPago) || isNaN(anioPrimerPago)) return 'N/A';
                
                // Crear fecha del primer pago
                const primerPago = new Date(anioPrimerPago, mesPrimerPago - 1, parseInt(diaPago));
                
                // Sumar cuotas pagadas
                const fechaVencida = new Date(primerPago);
                fechaVencida.setMonth(primerPago.getMonth() + cuotaPagada);
                
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const dia = fechaVencida.getDate();
                const mes = meses[fechaVencida.getMonth()];
                const anio = fechaVencida.getFullYear();
                
                return `${dia}/${mes}/${anio}`;
            } catch (error) {
                return 'N/A';
            }
        }

        // Función para cargar cobros próximos (próximos 5 días)
        async function loadCobrosProximos() {
            try {
                const tableBody = document.getElementById('cobros-table-body');
                const userEmailElement = document.getElementById('cobros-user-email');
                
                // Show loading state
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-spinner fa-spin text-3xl text-orange-600 mb-2"></i>
                            <p class="text-gray-600">Cargando cobros próximos...</p>
                        </td>
                    </tr>
                `;

                // Cargar todos los datos (usa cache si ya se cargó)
                const carteraData = await loadAllCarteraData();
                
                if (userEmailElement) {
                    userEmailElement.textContent = carteraData.userEmail;
                }

                // Separar créditos con fecha y sin fecha
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                const cobrosProximos = [];
                const sinFechaAsignada = [];
                
                (carteraData.data || []).forEach(credito => {
                    const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
                    const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
                    const plazo = parseInt(credito.plazo) || 0;
                    
                    // Verificar si ya completó todas las cuotas
                    if (plazo > 0 && cuotaPagada >= plazo) return;
                    
                    // Si no tiene fecha asignada, agregar a lista de sin fecha
                    if (!credito.dia_pago || !mesAnioPrimerPago) {
                        sinFechaAsignada.push(credito);
                        return;
                    }
                    
                    // Si tiene fecha, verificar si está en los próximos 5 días
                    const diasRestantes = diasHastaFecha(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                    
                    if (diasRestantes !== null && diasRestantes >= 0 && diasRestantes <= 5) {
                        cobrosProximos.push(credito);
                    }
                });

                // Ordenar cobros próximos por días restantes (más urgente primero)
                cobrosProximos.sort((a, b) => {
                    const cuotaPagadaA = parseInt(a.cuota_pagada) || 0;
                    const cuotaPagadaB = parseInt(b.cuota_pagada) || 0;
                    const mesAnioA = getMesAnioPrimerPago(a);
                    const mesAnioB = getMesAnioPrimerPago(b);
                    const diasA = diasHastaFecha(a.dia_pago, mesAnioA, cuotaPagadaA);
                    const diasB = diasHastaFecha(b.dia_pago, mesAnioB, cuotaPagadaB);
                    return diasA - diasB;
                });

                // Update stats
                updateCobrosProximosStats(cobrosProximos);
                
                // Render tablas
                renderSinFechaTable(sinFechaAsignada);
                renderCobrosProximosTable(cobrosProximos);

                // Show success message
                if (window.TupakAuth && window.TupakAuth.showToast) {
                    window.TupakAuth.showToast(
                        `${cobrosProximos.length} cobro(s) próximo(s) encontrado(s)`, 
                        'success'
                    );
                }

            } catch (error) {
                console.error('Error al cargar cobros próximos:', error);
                const tableBody = document.getElementById('cobros-table-body');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-600 mb-2"></i>
                            <p class="text-red-600 font-semibold">Error al cargar cobros próximos</p>
                            <p class="text-gray-600 text-sm">${error.message}</p>
                        </td>
                    </tr>
                `;
                
                if (window.TupakAuth && window.TupakAuth.showToast) {
                    window.TupakAuth.showToast('Error al cargar cobros próximos: ' + error.message, 'error');
                }
            }
        }

        // Función para actualizar estadísticas de cobros próximos
        function updateCobrosProximosStats(cobros) {
            const totalCobros = cobros.length;
            const montoTotal = cobros.reduce((sum, credito) => {
                const monto = parseFloat(credito.monto_aprobado) || 0;
                return sum + monto;
            }, 0);

            document.getElementById('cobros-pendientes-count').textContent = totalCobros;
            document.getElementById('cobros-monto-total').textContent = '$' + montoTotal.toLocaleString('es-ES', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }

        // Función para renderizar tabla de créditos sin fecha
        function renderSinFechaTable(sinFechaAsignada) {
            const container = document.getElementById('sin-fecha-container');
            const tableBody = document.getElementById('sin-fecha-table-body');
            const countElement = document.getElementById('sin-fecha-count');
            
            if (sinFechaAsignada.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            if (countElement) {
                countElement.textContent = sinFechaAsignada.length;
            }
            
            const rows = sinFechaAsignada.map(credito => {
                const montoFormateado = parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                const numeroCreditoUrl = credito.acta ? 
                    `https://cajatupakrantina.webcoopec.com/view/${credito.acta}` : '#';
                
                return `
                    <tr class="bg-yellow-50 hover:bg-yellow-100 transition-colors">
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${credito.nombre_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 text-right">${credito.cedula_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-bold text-right">$${montoFormateado}</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <div class="flex gap-2 justify-center">
                                <button onclick="openAsignarFechaModal(${credito.id})" 
                                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-md text-xs font-bold transition-colors shadow-sm">
                                    <i class="fas fa-calendar-plus mr-1"></i>
                                    Asignar Fecha
                                </button>
                                <a href="${numeroCreditoUrl}" 
                                   target="_blank"
                                   class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-xs font-bold transition-colors shadow-sm inline-flex items-center">
                                    <i class="fas fa-table mr-1"></i>
                                    Ver Tabla
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = rows;
        }

        // Función para renderizar tabla de cobros próximos
        function renderCobrosProximosTable(cobros) {
            const tableBody = document.getElementById('cobros-table-body');
            
            if (cobros.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center">
                            <i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i>
                            <p class="text-gray-600 font-semibold">¡No hay cobros próximos!</p>
                            <p class="text-gray-500 text-sm">No hay créditos con fecha de pago en los próximos 5 días</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let rows = cobros.map(credito => {
                const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
                const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
                const diasRestantes = diasHastaFecha(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                const urgenciaBadge = getUrgenciaBadge(diasRestantes);
                const primerPagoFormateado = formatearPrimerPago(mesAnioPrimerPago, credito.dia_pago);
                const montoFormateado = parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                const numeroCreditoUrl = credito.acta ? 
                    `https://cajatupakrantina.webcoopec.com/view/${credito.acta}` : '#';
                
                // Determinar color de fila según urgencia
                let rowClass = 'hover:bg-gray-50';
                if (diasRestantes === 0) {
                    rowClass = 'bg-red-50 hover:bg-red-100';
                } else if (diasRestantes === 1) {
                    rowClass = 'bg-orange-50 hover:bg-orange-100';
                } else if (diasRestantes <= 2) {
                    rowClass = 'bg-yellow-50 hover:bg-yellow-100';
                }
                
                return `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-4 py-3 text-sm font-bold text-gray-900">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-calendar-day text-orange-600"></i>
                                <span>Día ${credito.dia_pago}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            ${urgenciaBadge}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">${credito.nombre_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 text-right">${credito.cedula_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold text-right">$${montoFormateado}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 truncate max-w-xs" title="${credito.asesor_credito || 'N/A'}">${credito.asesor_credito || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex gap-2 justify-center flex-wrap">
                                <button onclick="confirmarEnviarNotificacion(${JSON.stringify(credito).replace(/"/g, '&quot;')})" 
                                        ${!canSendNotifications() || diasRestantes > 3 ? 'disabled' : ''}
                                        class="group bg-emerald-500 hover:bg-emerald-600 text-white px-2 py-2 md:px-3 md:py-1 rounded text-xs font-bold shadow-sm inline-flex items-center ${!canSendNotifications() || diasRestantes > 3 ? 'opacity-50 cursor-not-allowed' : ''}"
                                        title="${diasRestantes > 3 ? 'Solo se puede notificar cuando falten 3 días o menos' : 'Enviar recordatorio por WhatsApp'}">
                                    <i class="fab fa-whatsapp flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Notificar</span>
                                </button>
                                <button onclick="confirmarMarcarPagado(${JSON.stringify(credito).replace(/"/g, '&quot;')})" 
                                        ${isAdminUser() ? 'disabled' : ''}
                                        class="group bg-blue-500 hover:bg-blue-600 text-white px-2 py-2 md:px-3 md:py-1 rounded text-xs font-bold shadow-sm inline-flex items-center ${isAdminUser() ? 'opacity-50 cursor-not-allowed' : ''}"
                                        title="${isAdminUser() ? 'Solo los asesores pueden marcar como pagado' : 'Marcar cuota como pagada'}">
                                    <i class="fas fa-check-circle flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Pagado</span>
                                </button>
                                <a href="tel:${credito.telefono_socio}" 
                                   class="group bg-green-500 hover:bg-green-600 text-white px-2 py-2 md:px-3 md:py-1 rounded text-xs font-bold shadow-sm inline-flex items-center">
                                    <i class="fas fa-phone flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Llamar</span>
                                </a>
                                <a href="${numeroCreditoUrl}" 
                                   target="_blank"
                                   class="group bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-2 md:px-3 md:py-1 rounded text-xs font-bold shadow-sm inline-flex items-center">
                                    <i class="fas fa-table flex-shrink-0"></i>
                                    <span class="btn-text hidden md:inline-block">Ver Tabla</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        // Constantes para el caché
        const CARTERA_CACHE_KEY = 'tupak_cartera_access';
        const CARTERA_CACHE_EMAIL_KEY = 'tupak_cartera_email';
        const CARTERA_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas en milisegundos

        // Variables globales para notificaciones
        let userNotificationConfig = {
            user: null,
            apikey: null,
            instance: null,
            active: false,
            correo: null
        };

        // ===== FUNCIONES DE UI PARA NOTIFICACIONES =====
        
        // Mostrar loader de notificación
        function showNotificationLoader(title = 'Enviando notificación...', message = 'Por favor espera mientras se envía el mensaje por WhatsApp', iconType = 'whatsapp') {
            const loader = document.getElementById('notification-loader');
            const titleEl = document.getElementById('notification-loader-title');
            const messageEl = document.getElementById('notification-loader-message');
            const iconEl = document.getElementById('notification-loader-icon');
            const iconContainerEl = document.getElementById('notification-loader-icon-container');
            const progressEl = document.getElementById('notification-loader-progress');
            
            // Configurar íconos según el tipo
            const iconConfig = {
                whatsapp: {
                    icon: 'fab fa-whatsapp',
                    bgColor: 'bg-green-500',
                    progressColor: 'from-green-400 to-green-600'
                },
                update: {
                    icon: 'fas fa-sync-alt fa-spin',
                    bgColor: 'bg-blue-500',
                    progressColor: 'from-blue-400 to-blue-600'
                },
                save: {
                    icon: 'fas fa-save',
                    bgColor: 'bg-indigo-500',
                    progressColor: 'from-indigo-400 to-indigo-600'
                },
                loading: {
                    icon: 'fas fa-spinner fa-spin',
                    bgColor: 'bg-gray-500',
                    progressColor: 'from-gray-400 to-gray-600'
                }
            };
            
            const config = iconConfig[iconType] || iconConfig.whatsapp;
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.textContent = message;
            
            if (iconEl) {
                iconEl.className = `${config.icon} text-white text-5xl`;
            }
            
            if (iconContainerEl) {
                iconContainerEl.className = `w-20 h-20 ${config.bgColor} rounded-full flex items-center justify-center animate-pulse`;
            }
            
            if (progressEl) {
                progressEl.className = `h-full bg-gradient-to-r ${config.progressColor} rounded-full animate-progress`;
            }
            
            if (loader) loader.classList.remove('hidden');
        }
        
        // Ocultar loader de notificación
        function hideNotificationLoader() {
            const loader = document.getElementById('notification-loader');
            if (loader) loader.classList.add('hidden');
        }
        
        // Mostrar modal de confirmación
        function showConfirmModal(title, message, onConfirm, headerColor = 'from-blue-500 to-blue-600') {
            const modal = document.getElementById('confirm-modal');
            const header = document.getElementById('confirm-modal-header');
            const titleEl = document.getElementById('confirm-modal-title');
            const messageEl = document.getElementById('confirm-modal-message');
            const acceptBtn = document.getElementById('confirm-modal-accept');
            
            if (titleEl) titleEl.innerHTML = `<i class="fas fa-question-circle mr-3"></i>${title}`;
            if (messageEl) messageEl.innerHTML = message;
            if (header) header.className = `bg-gradient-to-r ${headerColor} p-6 rounded-t-lg`;
            if (modal) modal.classList.remove('hidden');
            
            // Remover listeners anteriores y agregar nuevo
            const newAcceptBtn = acceptBtn.cloneNode(true);
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
            
            newAcceptBtn.addEventListener('click', () => {
                closeConfirmModal();
                if (onConfirm) onConfirm();
            });
        }
        
        // Cerrar modal de confirmación
        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        // Mostrar toast personalizado
        function showCustomToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('custom-toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            const icons = {
                success: '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                error: '<i class="fas fa-times-circle text-red-500 text-xl"></i>',
                warning: '<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>',
                info: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
            };
            
            const colors = {
                success: 'bg-green-50 border-green-200',
                error: 'bg-red-50 border-red-200',
                warning: 'bg-yellow-50 border-yellow-200',
                info: 'bg-blue-50 border-blue-200'
            };
            
            toast.className = `${colors[type]} border-l-4 rounded-lg shadow-lg p-4 flex items-start gap-3 max-w-md animate-slideIn`;
            toast.innerHTML = `
                ${icons[type]}
                <div class="flex-1">
                    <p class="text-gray-800 font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // Agregar estilos para animación
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            .animate-slideIn {
                animation: slideIn 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);

        // Función para obtener el caché de acceso a cartera
        function getCarteraAccessCache(userEmail) {
            try {
                const cachedAccess = localStorage.getItem(CARTERA_CACHE_KEY);
                const cachedEmail = localStorage.getItem(CARTERA_CACHE_EMAIL_KEY);
                const cacheTimestamp = localStorage.getItem(CARTERA_CACHE_KEY + '_timestamp');

                // Verificar si el caché es válido
                if (cachedAccess !== null && cachedEmail === userEmail && cacheTimestamp) {
                    const cacheAge = Date.now() - parseInt(cacheTimestamp);
                    if (cacheAge < CARTERA_CACHE_DURATION) {
                        return cachedAccess === 'true';
                    }
                }

                return null; // No hay caché válido

            } catch (error) {
                console.error('Error al leer caché de cartera:', error);
                return null;
            }
        }

        // Función para guardar el caché de acceso a cartera
        function setCarteraAccessCache(userEmail, hasAccess) {
            try {
                localStorage.setItem(CARTERA_CACHE_KEY, hasAccess.toString());
                localStorage.setItem(CARTERA_CACHE_EMAIL_KEY, userEmail);
                localStorage.setItem(CARTERA_CACHE_KEY + '_timestamp', Date.now().toString());
            } catch (error) {
                console.error('Error al guardar caché de cartera:', error);
            }
        }

        // ===== SISTEMA DE NOTIFICACIONES =====
        
        // Función para cargar configuración de notificaciones del usuario
        async function loadUserNotificationConfig(userEmail) {
            try {
                console.log('🔔 Cargando configuración de notificaciones para:', userEmail);
                
                const { data, error } = await supabase
                    .from('usertr')
                    .select('*')
                    .eq('correo', userEmail)
                    .single();
                
                if (error) {
                    console.warn('No se encontró configuración de notificaciones:', error);
                    userNotificationConfig = {
                        user: null,
                        apikey: null,
                        instance: null,
                        active: false,
                        correo: userEmail
                    };
                    return;
                }
                
                // Limpiar valores "no" y tratarlos como null
                const apikey = (data.apikey && data.apikey.toLowerCase() !== 'no' && data.apikey.trim() !== '') 
                    ? data.apikey 
                    : null;
                
                const instance = (data.instance && data.instance.toLowerCase() !== 'no' && data.instance.trim() !== '') 
                    ? data.instance 
                    : null;
                
                userNotificationConfig = {
                    user: data.user || null,
                    apikey: apikey,
                    instance: instance,
                    active: data.active || false,
                    correo: userEmail
                };
                
                const canNotify = canSendNotifications();
                
                console.log('✅ Configuración de notificaciones cargada:', {
                    user: userNotificationConfig.user,
                    apikey: apikey ? '***' + apikey.slice(-4) : '❌ NO configurado',
                    instance: instance || '❌ NO configurado',
                    active: userNotificationConfig.active,
                    canSendNotifications: canNotify ? '✅ SÍ' : '❌ NO'
                });
                
                // Actualizar nombre de usuario en el header
                if (userNotificationConfig.user && userNotificationConfig.user.toLowerCase() !== 'no') {
                    const userInfoElement = document.getElementById('user-info');
                    if (userInfoElement) {
                        userInfoElement.textContent = userNotificationConfig.user;
                    }
                    // Guardar nombre en localStorage para otras páginas
                    localStorage.setItem('nombreUsuarioActual', userNotificationConfig.user.toUpperCase());
                } else {
                    // Si no hay nombre en usertr, intentar con metadatos del usuario
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        const userName = user.user_metadata?.full_name || 
                                       user.user_metadata?.nombre || 
                                       user.user_metadata?.name || 
                                       user.email?.split('@')[0] || 
                                       'Usuario';
                        localStorage.setItem('nombreUsuarioActual', userName.toUpperCase());
                    }
                }
                
            } catch (error) {
                console.error('Error al cargar configuración de notificaciones:', error);
                userNotificationConfig = {
                    user: null,
                    apikey: null,
                    instance: null,
                    active: false,
                    correo: userEmail
                };
            }
        }

        // Función para verificar si las notificaciones están habilitadas
        function canSendNotifications() {
            const hasApiKey = userNotificationConfig.apikey && 
                            userNotificationConfig.apikey.toLowerCase() !== 'no' &&
                            userNotificationConfig.apikey.trim() !== '';
            
            const hasInstance = userNotificationConfig.instance && 
                              userNotificationConfig.instance.toLowerCase() !== 'no' &&
                              userNotificationConfig.instance.trim() !== '';
            
            return userNotificationConfig.active && hasApiKey && hasInstance;
        }
        
        // Función para verificar si el usuario es admin
        function isAdminUser() {
            return userNotificationConfig.correo === 'contacto@tupakrantina.com';
        }

        // Función para formatear fecha en texto (ejemplo: "22 de noviembre del 2025")
        function formatearFechaTexto(diaPago, mesAnioPrimerPago, cuotaPagada) {
            try {
                const mesesTexto = [
                    'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                    'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
                ];
                
                const [mes, anio] = mesAnioPrimerPago.split('/');
                const mesPrimerPago = parseInt(mes);
                const anioPrimerPago = parseInt(anio);
                
                const primerPago = new Date(anioPrimerPago, mesPrimerPago - 1, parseInt(diaPago));
                const proximoPago = new Date(primerPago);
                proximoPago.setMonth(primerPago.getMonth() + parseInt(cuotaPagada));
                
                const dia = proximoPago.getDate();
                const mesTexto = mesesTexto[proximoPago.getMonth()];
                const anioProximo = proximoPago.getFullYear();
                
                return `${dia} de ${mesTexto} del ${anioProximo}`;
            } catch (error) {
                console.error('Error al formatear fecha:', error);
                return 'próximamente';
            }
        }

        // Función para marcar crédito como pagado
        async function marcarComoPagado(credito, nuevoCapitalTexto) {
            try {
                // Validar que no sea admin
                if (isAdminUser()) {
                    showCustomToast('Solo los asesores de crédito pueden marcar pagos. El administrador solo tiene acceso de consulta.', 'error', 5000);
                    return;
                }
                
                const cuotaActual = parseInt(credito.cuota_pagada) || 0;
                const plazoTotal = parseInt(credito.plazo) || 0;
                const nuevaCuota = cuotaActual + 1;
                
                // Validar que no exceda el plazo
                if (nuevaCuota > plazoTotal) {
                    showCustomToast(`Este crédito ya está completamente pagado (${plazoTotal} cuotas)`, 'warning', 4000);
                    return;
                }
                
                showNotificationLoader(
                    'Actualizando crédito...',
                    `Registrando pago de cuota ${nuevaCuota} de ${plazoTotal} y actualizando capital a $${nuevoCapitalTexto}`,
                    'update'
                );
                
                // Actualizar en Supabase (ambas columnas: cuota_pagada y capital_restante)
                const { data, error } = await supabase
                    .from('actas_creditos_tupakra')
                    .update({
                        'cuota_pagada': nuevaCuota.toString(),
                        'capital_restante': nuevoCapitalTexto
                    })
                    .eq('id', credito.id)
                    .select();
                
                hideNotificationLoader();
                
                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    throw new Error('No se pudo actualizar el crédito. Verifica los permisos.');
                }
                
                console.log('✅ Crédito actualizado:', data[0]);
                
                // Limpiar caché y recargar vistas
                carteraDataCache = null;
                
                // Recargar la vista actual
                const activeView = document.querySelector('[id^="cartera-view-"]:not(.hidden)');
                if (activeView) {
                    if (activeView.id === 'cartera-view-atrasados') {
                        await loadAtrasados();
                    } else if (activeView.id === 'cartera-view-cobros') {
                        await loadCobrosProximos();
                    } else if (activeView.id === 'cartera-view-general') {
                        await loadCartera();
                    }
                }
                
                showCustomToast(
                    `✅ Pago registrado: Cuota ${nuevaCuota}/${plazoTotal} | Capital: $${nuevoCapitalTexto}`, 
                    'success', 
                    6000
                );
                
                // Limpiar datos temporales
                window.tempCreditoData = null;
                
            } catch (error) {
                console.error('❌ Error al marcar como pagado:', error);
                hideNotificationLoader();
                showCustomToast(`Error al registrar el pago: ${error.message}`, 'error', 5000);
            }
        }
        
        // Función para confirmar y marcar como pagado
        function confirmarMarcarPagado(credito) {
            const cuotaActual = parseInt(credito.cuota_pagada) || 0;
            const plazoTotal = parseInt(credito.plazo) || 0;
            const siguienteCuota = cuotaActual + 1;
            const capitalActual = credito.capital_restante || '0,00';
            const capitalActualNumero = parseEuropeanNumber(capitalActual);
            
            // Crear modal personalizado para solicitar capital vigente
            const modalHTML = `
                <div id="modal-capital-pagado" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-t-2xl">
                            <h3 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-hand-holding-dollar mr-3"></i>
                                Registrar Pago
                            </h3>
                        </div>
                        
                        <!-- Body -->
                        <div class="p-6 space-y-4">
                            <!-- Info del crédito -->
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-2">
                                <p class="text-sm"><strong>Socio:</strong> ${credito.nombre_socio || 'N/A'}</p>
                                <p class="text-sm"><strong>Cédula:</strong> ${credito.cedula_socio || 'N/A'}</p>
                                <p class="text-sm"><strong>Acta:</strong> ${credito.acta || 'N/A'}</p>
                                <p class="text-sm"><strong>Cuota actual:</strong> ${cuotaActual} de ${plazoTotal}</p>
                                <p class="text-sm"><strong>Nueva cuota:</strong> <span class="text-green-600 font-bold">${siguienteCuota} de ${plazoTotal}</span></p>
                            </div>
                            
                            <!-- Capital actual -->
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300">
                                <p class="text-sm font-semibold text-gray-700 mb-1">Capital Actual:</p>
                                <p class="text-2xl font-bold text-gray-800">$${capitalActual}</p>
                            </div>
                            
                            <!-- Botón Ver Tabla -->
                            <div class="flex justify-center">
                                <a 
                                    href="https://cajatupakrantina.webcoopec.com/view/${credito.acta || ''}" 
                                    target="_blank"
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors shadow-md"
                                >
                                    <i class="fas fa-table"></i>
                                    Ver Tabla de Amortización
                                </a>
                            </div>
                            
                            <!-- Input nuevo capital -->
                            <div class="space-y-2">
                                <label class="block">
                                    <span class="text-sm font-semibold text-gray-700">Nuevo Capital Vigente <span class="text-red-500">*</span></span>
                                    <p class="text-xs text-gray-500 mb-2">Usa <strong>.</strong> para miles y <strong>,</strong> para decimales (Ejemplo: 8.500,50)</p>
                                    <input 
                                        type="text" 
                                        id="input-nuevo-capital" 
                                        placeholder="Ejemplo: 8.500,50"
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 text-lg font-semibold"
                                    />
                                </label>
                                <p id="error-capital" class="text-red-600 text-sm font-semibold hidden"></p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="p-6 bg-gray-50 rounded-b-2xl flex gap-3">
                            <button 
                                onclick="cerrarModalCapital()" 
                                class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition-colors"
                            >
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button 
                                onclick="validarYConfirmarPago()" 
                                class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-lg transition-all shadow-lg"
                            >
                                <i class="fas fa-check mr-2"></i>Continuar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar modal en el DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Guardar datos en una variable global temporal
            window.tempCreditoData = {
                credito: credito,
                capitalActual: capitalActualNumero,
                siguienteCuota: siguienteCuota,
                plazoTotal: plazoTotal
            };
            
            // Focus en el input
            setTimeout(() => {
                document.getElementById('input-nuevo-capital').focus();
            }, 100);
        }
        
        // Función para cerrar modal de capital
        window.cerrarModalCapital = function() {
            const modal = document.getElementById('modal-capital-pagado');
            if (modal) modal.remove();
            window.tempCreditoData = null;
        };
        
        // Función para validar y confirmar pago
        window.validarYConfirmarPago = function() {
            const inputCapital = document.getElementById('input-nuevo-capital');
            const errorElement = document.getElementById('error-capital');
            const nuevoCapitalTexto = inputCapital.value.trim();
            
            // Validar que no esté vacío
            if (!nuevoCapitalTexto) {
                errorElement.textContent = '⚠️ El capital vigente es obligatorio';
                errorElement.classList.remove('hidden');
                inputCapital.classList.add('border-red-500');
                return;
            }
            
            // Validar formato (debe tener punto para miles y coma para decimales)
            const formatoValido = /^[\d.]+,\d{2}$/.test(nuevoCapitalTexto);
            if (!formatoValido) {
                errorElement.textContent = '⚠️ Formato incorrecto. Usa . para miles y , para decimales (Ej: 8.500,50)';
                errorElement.classList.remove('hidden');
                inputCapital.classList.add('border-red-500');
                return;
            }
            
            // Parsear a número
            const nuevoCapitalNumero = parseEuropeanNumber(nuevoCapitalTexto);
            
            // Validar que sea menor al capital actual
            if (nuevoCapitalNumero >= window.tempCreditoData.capitalActual) {
                errorElement.textContent = `⚠️ El nuevo capital debe ser menor a $${formatEuropeanNumber(window.tempCreditoData.capitalActual)}`;
                errorElement.classList.remove('hidden');
                inputCapital.classList.add('border-red-500');
                return;
            }
            
            // Validar que no sea negativo
            if (nuevoCapitalNumero < 0) {
                errorElement.textContent = '⚠️ El capital no puede ser negativo';
                errorElement.classList.remove('hidden');
                inputCapital.classList.add('border-red-500');
                return;
            }
            
            // Todo OK - guardar datos y mostrar confirmación final
            const datosGuardados = { ...window.tempCreditoData };
            cerrarModalCapital();
            mostrarConfirmacionFinalPago(nuevoCapitalTexto, nuevoCapitalNumero, datosGuardados);
        };
        
        // Función para mostrar confirmación final con el valor en grande
        function mostrarConfirmacionFinalPago(nuevoCapitalTexto, nuevoCapitalNumero, datosGuardados) {
            const { credito, capitalActual, siguienteCuota, plazoTotal } = datosGuardados;
            
            showConfirmModal(
                'Confirmar Actualización',
                `<div class="space-y-4">
                    <p class="font-semibold text-gray-800 text-center">¿Confirmar el registro de pago?</p>
                    
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border-2 border-green-300">
                        <p class="text-sm text-gray-600 text-center mb-2">Nuevo Capital Vigente:</p>
                        <p class="text-4xl font-bold text-green-700 text-center">$${nuevoCapitalTexto}</p>
                    </div>
                    
                    <!-- Botón Ver Tabla -->
                    <div class="flex justify-center">
                        <a 
                            href="https://cajatupakrantina.webcoopec.com/view/${credito.acta || ''}" 
                            target="_blank"
                            class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors shadow-md"
                        >
                            <i class="fas fa-table"></i>
                            Ver Tabla de Amortización
                        </a>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-1 text-sm">
                        <p><strong>Socio:</strong> ${credito.nombre_socio || 'N/A'}</p>
                        <p><strong>Acta:</strong> ${credito.acta || 'N/A'}</p>
                        <p><strong>Cuota:</strong> ${siguienteCuota} de ${plazoTotal}</p>
                        <p><strong>Capital anterior:</strong> <span class="line-through text-gray-500">$${formatEuropeanNumber(capitalActual)}</span></p>
                        <p><strong>Capital nuevo:</strong> <span class="text-green-600 font-bold">$${nuevoCapitalTexto}</span></p>
                    </div>
                    
                    <p class="text-xs text-gray-500 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        Se actualizarán la cuota pagada y el capital restante
                    </p>
                </div>`,
                () => marcarComoPagado(credito, nuevoCapitalTexto),
                'from-green-500 to-green-600'
            );
        }

        // Función para confirmar envío de notificación
        function confirmarEnviarNotificacion(credito) {
            // Calcular fecha de pago para mostrar
            const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
            const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
            const fechaPagoTexto = formatearFechaTexto(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
            
            showConfirmModal(
                'Enviar Notificación',
                `<div class="space-y-3">
                    <p class="font-semibold text-gray-800">¿Enviar recordatorio de pago por WhatsApp?</p>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm"><strong>Socio:</strong> ${credito.nombre_socio || 'N/A'}</p>
                        <p class="text-sm"><strong>Teléfono:</strong> ${credito.telefono_socio || 'N/A'}</p>
                        <p class="text-sm"><strong>Fecha de pago:</strong> ${fechaPagoTexto}</p>
                        <p class="text-sm"><strong>Monto:</strong> $${parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES')}</p>
                    </div>
                    <p class="text-sm text-gray-600">
                        <i class="fab fa-whatsapp text-green-600 mr-1"></i>
                        Se enviará un mensaje de recordatorio amigable al socio.
                    </p>
                </div>`,
                () => enviarNotificacionWhatsApp(credito),
                'from-green-500 to-green-600'
            );
        }
        
        // Función para enviar notificación de WhatsApp
        async function enviarNotificacionWhatsApp(credito) {
            try {
                if (!canSendNotifications()) {
                    let mensajeError = 'No puedes enviar notificaciones: ';
                    let detalles = [];
                    
                    if (!userNotificationConfig.active) {
                        detalles.push('Tu cuenta no está activa');
                    }
                    if (!userNotificationConfig.apikey || userNotificationConfig.apikey.toLowerCase() === 'no') {
                        detalles.push('No tienes API Key configurado');
                    }
                    if (!userNotificationConfig.instance || userNotificationConfig.instance.toLowerCase() === 'no') {
                        detalles.push('No tienes Instancia configurada');
                    }
                    
                    mensajeError += detalles.join(', ') + '. Contacta al administrador.';
                    showCustomToast(mensajeError, 'error', 6000);
                    return;
                }
                
                // Validar días restantes (solo permitir si faltan 3 días o menos, o ya está atrasado)
                const cuotaPagadaValidacion = parseInt(credito.cuota_pagada) || 0;
                const mesAnioPrimerPagoValidacion = getMesAnioPrimerPago(credito);
                const diasRestantesValidacion = diasHastaFecha(credito.dia_pago, mesAnioPrimerPagoValidacion, cuotaPagadaValidacion);
                
                if (diasRestantesValidacion > 3) {
                    showCustomToast(`Solo se pueden enviar notificaciones cuando falten 3 días o menos. Actualmente faltan ${diasRestantesValidacion} días.`, 'warning', 5000);
                    return;
                }
                
                // Validar y formatear teléfono
                let telefono = credito.telefono_socio || '';
                telefono = telefono.replace(/\D/g, ''); // Eliminar caracteres no numéricos
                
                if (!telefono || telefono.length < 9) {
                    showCustomToast('El socio no tiene un teléfono válido registrado (mínimo 9 dígitos).', 'error', 4000);
                    return;
                }
                
                // Tomar los últimos 9 dígitos y agregar +593
                const ultimosNueve = telefono.slice(-9);
                telefono = `+593${ultimosNueve}`;
                
                console.log('📱 Teléfono formateado:', telefono);
                
                // Calcular fecha de pago
                const cuotaPagada = parseInt(credito.cuota_pagada) || 0;
                const mesAnioPrimerPago = getMesAnioPrimerPago(credito);
                const fechaPagoTexto = formatearFechaTexto(credito.dia_pago, mesAnioPrimerPago, cuotaPagada);
                
                // Construir mensaje personalizado
                const nombreSocio = credito.nombre_socio || 'Estimado socio';
                const userName = userNotificationConfig.user || 'La Caja';
                
                const mensaje = `Hola *${nombreSocio}*, le saluda *${userName}* de la *CAJA DE AHORRO Y CRÉDITO TUPAK RANTINA*.

El motivo de mi mensaje es solo para recordarle que el día *${fechaPagoTexto}* le toca el pago de su crédito.

Ante cualquier pregunta, estoy para servirle. Este mensaje es solo un recordatorio y no pretende causar molestia o inconvenientes.

¡Que tenga un excelente día! 😊`;
                
                // URL del webhook
                const url = `https://api.luispinta.com/message/sendMedia/${userNotificationConfig.instance}`;
                
                // Preparar payload
                const payload = {
                    number: telefono,
                    mediatype: "image",
                    mimetype: "image/png",
                    caption: mensaje,
                    media: "https://lh3.googleusercontent.com/d/1oMybBIAVHNJaxK-xwDVt379sl_eW0Qhi=w2048",
                    fileName: "recordatorio_pago.png",
                    delay: 0,
                    linkPreview: false,
                    mentionsEveryOne: false
                };
                
                console.log('📤 Enviando notificación:', { telefono, userName });
                
                // Mostrar loader
                showNotificationLoader(
                    'Enviando notificación...',
                    `Enviando recordatorio de pago a ${nombreSocio} vía WhatsApp`,
                    'whatsapp'
                );
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'apikey': userNotificationConfig.apikey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                console.log('📥 Respuesta del servidor:', data);
                
                // Ocultar loader
                hideNotificationLoader();
                
                if (response.ok) {
                    showCustomToast(`✅ Notificación enviada exitosamente a ${nombreSocio}`, 'success', 5000);
                } else {
                    throw new Error(data.message || 'Error al enviar mensaje');
                }
                
            } catch (error) {
                console.error('❌ Error al enviar notificación:', error);
                hideNotificationLoader();
                showCustomToast(`Error al enviar notificación: ${error.message}`, 'error', 5000);
            }
        }

        // Función para limpiar el caché de acceso a cartera
        function clearCarteraAccessCache() {
            try {
                localStorage.removeItem(CARTERA_CACHE_KEY);
                localStorage.removeItem(CARTERA_CACHE_EMAIL_KEY);
                localStorage.removeItem(CARTERA_CACHE_KEY + '_timestamp');
            } catch (error) {
                console.error('Error al limpiar caché de cartera:', error);
            }
        }

        // Función para verificar acceso a la pestaña de Cartera
        async function checkCarteraAccess(userEmail = null, useCache = true) {
            try {
                // Get current user if not provided
                if (!userEmail) {
                    const { data: { user }, error: userError } = await supabase.auth.getUser();
                    
                    if (userError || !user) {
                        return false;
                    }
                    userEmail = user.email;
                }

                // Intentar obtener desde caché primero
                if (useCache) {
                    const cachedAccess = getCarteraAccessCache(userEmail);
                    if (cachedAccess !== null) {
                        console.log('Usando acceso a cartera desde caché');
                        return cachedAccess;
                    }
                }

                // Admin siempre tiene acceso
                if (userEmail === 'contacto@tupakrantina.com') {
                    setCarteraAccessCache(userEmail, true);
                    return true;
                }

                // Verificar si el usuario tiene créditos asignados
                const { data, error } = await supabase
                    .from('actas_creditos_tupakra')
                    .select('id')
                    .eq('correo_asesor', userEmail)
                    .limit(1);

                if (error) {
                    console.error('Error verificando acceso a cartera:', error);
                    return false;
                }

                // Tiene acceso si tiene al menos un crédito
                const hasAccess = data && data.length > 0;
                
                // Guardar en caché
                setCarteraAccessCache(userEmail, hasAccess);
                
                return hasAccess;

            } catch (error) {
                console.error('Error en checkCarteraAccess:', error);
                return false;
            }
        }

        // Función para mostrar/ocultar pestaña de Cartera (con aplicación inmediata del caché)
        async function toggleCarteraTab(forceCheck = false) {
            const desktopTab = document.getElementById('desktop-cartera-tab');
            const mobileTab = document.getElementById('mobile-cartera-tab');

            // Obtener email del usuario actual
            let userEmail = null;
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    userEmail = user.email;
                }
            } catch (error) {
                console.error('Error obteniendo usuario:', error);
            }

            if (!userEmail) {
                // Sin usuario, ocultar pestaña
                if (desktopTab) desktopTab.classList.add('hidden');
                if (mobileTab) mobileTab.classList.add('hidden');
                return;
            }

            // Aplicar caché inmediatamente para evitar pestañeo
            const cachedAccess = getCarteraAccessCache(userEmail);
            if (cachedAccess !== null && !forceCheck) {
                // Aplicar estado cacheado inmediatamente
                if (cachedAccess) {
                    if (desktopTab) desktopTab.classList.remove('hidden');
                    if (mobileTab) mobileTab.classList.remove('hidden');
                } else {
                    if (desktopTab) desktopTab.classList.add('hidden');
                    if (mobileTab) mobileTab.classList.add('hidden');
                }
                hasCarteraAccess = cachedAccess;
                
                // Verificar en segundo plano si el acceso sigue siendo válido
                checkCarteraAccess(userEmail, false).then(actualAccess => {
                    if (actualAccess !== cachedAccess) {
                        // El acceso cambió, actualizar UI
                        console.log('Acceso a cartera cambió, actualizando...');
                        hasCarteraAccess = actualAccess;
                        if (actualAccess) {
                            if (desktopTab) desktopTab.classList.remove('hidden');
                            if (mobileTab) mobileTab.classList.remove('hidden');
                        } else {
                            if (desktopTab) desktopTab.classList.add('hidden');
                            if (mobileTab) mobileTab.classList.add('hidden');
                        }
                    }
                });
            } else {
                // No hay caché, verificar y aplicar
                hasCarteraAccess = await checkCarteraAccess(userEmail, false);
                
                if (hasCarteraAccess) {
                    if (desktopTab) desktopTab.classList.remove('hidden');
                    if (mobileTab) mobileTab.classList.remove('hidden');
                } else {
                    if (desktopTab) desktopTab.classList.add('hidden');
                    if (mobileTab) mobileTab.classList.add('hidden');
                }
            }
        }

        // ===== FUNCIONES DE ACCESO A COMITÉ =====

        // Función para verificar acceso a la pestaña de Comité
        async function checkComiteAccess(userEmail = null, useCache = true) {
            try {
                // Get current user if not provided
                if (!userEmail) {
                    const { data: { user }, error: userError } = await supabase.auth.getUser();

                    if (userError || !user) {
                        return false;
                    }
                    userEmail = user.email;
                }

                // Admin siempre tiene acceso
                if (userEmail === 'contacto@tupakrantina.com') {
                    return true;
                }

                // Verificar si el usuario es asesor de crédito (tiene créditos asignados)
                const { data, error } = await supabase
                    .from('actas_creditos_tupakra')
                    .select('id')
                    .eq('correo_asesor', userEmail)
                    .limit(1);

                if (error) {
                    console.error('Error verificando acceso a comité:', error);
                    return false;
                }

                // Tiene acceso si es asesor (tiene al menos un crédito asignado)
                const hasAccess = data && data.length > 0;

                return hasAccess;

            } catch (error) {
                console.error('Error en checkComiteAccess:', error);
                return false;
            }
        }

        // Función para mostrar/ocultar pestaña de Comité
        async function toggleComiteTab(forceCheck = false) {
            const desktopTab = document.getElementById('desktop-comite-tab');
            const mobileTab = document.getElementById('mobile-comite-tab');

            // Obtener email del usuario actual
            let userEmail = null;
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    userEmail = user.email;
                }
            } catch (error) {
                console.error('Error obteniendo usuario:', error);
            }

            if (!userEmail) {
                // Sin usuario, ocultar pestaña
                if (desktopTab) desktopTab.classList.add('hidden');
                if (mobileTab) mobileTab.classList.add('hidden');
                return;
            }

            // Verificar acceso y aplicar
            const hasAccess = await checkComiteAccess(userEmail, false);

            if (hasAccess) {
                if (desktopTab) desktopTab.classList.remove('hidden');
                if (mobileTab) mobileTab.classList.remove('hidden');
            } else {
                if (desktopTab) desktopTab.classList.add('hidden');
                if (mobileTab) mobileTab.classList.add('hidden');
            }
        }

        async function loadCreditos() {
            try {
                const tableBody = document.getElementById('creditos-table-body');
                const currentUserEmail = document.getElementById('current-user-email');
                const adminDashboard = document.getElementById('admin-dashboard');
                
                // Show loading state
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-spinner fa-spin text-3xl text-indigo-600 mb-2"></i>
                            <p class="text-gray-600">Cargando cartera...</p>
                        </td>
                    </tr>
                `;

                // Cargar todos los datos (usa cache si ya se cargó)
                const carteraData = await loadAllCarteraData();
                
                currentUserEmail.textContent = carteraData.userEmail;

                // Show/hide admin dashboard
                if (adminDashboard) {
                    if (carteraData.isAdmin) {
                        adminDashboard.classList.remove('hidden');
                    } else {
                        adminDashboard.classList.add('hidden');
                    }
                }

                // Ordenar por fecha de creación (más reciente primero) para la vista general
                creditosData = [...carteraData.data].sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;
                });
                filteredCreditos = creditosData;
                
                // Update stats
                updateCreditosStats();
                
                // Update admin dashboard if admin
                if (carteraData.isAdmin) {
                    updateAdminDashboard();
                }
                
                // Render table
                renderCreditosTable();

                // Show success message
                if (window.TupakAuth && window.TupakAuth.showToast) {
                    window.TupakAuth.showToast(
                        `${creditosData.length} registro(s) de cartera cargado(s)`, 
                        'success'
                    );
                }

            } catch (error) {
                console.error('Error al cargar créditos:', error);
                const tableBody = document.getElementById('creditos-table-body');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-600 mb-2"></i>
                            <p class="text-red-600 font-semibold">Error al cargar cartera</p>
                            <p class="text-gray-600 text-sm">${error.message}</p>
                        </td>
                    </tr>
                `;
                
                if (window.TupakAuth && window.TupakAuth.showToast) {
                    window.TupakAuth.showToast('Error al cargar cartera: ' + error.message, 'error');
                }
            }
        }

        function updateCreditosStats() {
            const totalCreditos = filteredCreditos.length;
            const montoTotal = filteredCreditos.reduce((sum, credito) => {
                const monto = parseFloat(credito.monto_aprobado) || 0;
                return sum + monto;
            }, 0);

            document.getElementById('total-creditos').textContent = totalCreditos;
            document.getElementById('monto-total').textContent = '$' + montoTotal.toLocaleString('es-ES', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }

        // Función para parsear formato europeo (9.092,34) a número
        function parseEuropeanNumber(value) {
            if (!value) return 0;
            // Convertir a string y eliminar espacios
            const str = String(value).trim();
            // Reemplazar puntos (miles) por nada y comas (decimales) por punto
            const normalized = str.replace(/\./g, '').replace(',', '.');
            return parseFloat(normalized) || 0;
        }

        // Función para formatear número a formato europeo (9.092,34)
        function formatEuropeanNumber(value) {
            if (!value || isNaN(value)) return '0,00';
            // Formatear con separador de miles (.) y decimales (,)
            return value.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function updateAdminDashboard() {
            // Calcular estadísticas globales
            const totalCreditos = creditosData.length;
            const montoTotal = creditosData.reduce((sum, credito) => {
                const monto = parseFloat(credito.monto_aprobado) || 0;
                return sum + monto;
            }, 0);
            const capitalVigente = creditosData.reduce((sum, credito) => {
                const capital = parseEuropeanNumber(credito.capital_restante);
                return sum + capital;
            }, 0);
            const promedioMonto = totalCreditos > 0 ? montoTotal / totalCreditos : 0;

            // Agrupar por asesor
            const creditosPorAsesor = {};
            creditosData.forEach(credito => {
                const asesor = credito.correo_asesor || 'Sin Asesor';
                if (!creditosPorAsesor[asesor]) {
                    creditosPorAsesor[asesor] = {
                        nombre: credito.asesor_credito || asesor,
                        correo: asesor,
                        totalCreditos: 0,
                        montoTotal: 0
                    };
                }
                creditosPorAsesor[asesor].totalCreditos++;
                creditosPorAsesor[asesor].montoTotal += parseFloat(credito.monto_aprobado) || 0;
            });

            const totalAsesores = Object.keys(creditosPorAsesor).length;

            // Calcular estadísticas de los últimos 3 meses
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const hoy = new Date();
            const mesActual = hoy.getMonth(); // 0-11
            const anioActual = hoy.getFullYear();
            
            // Calcular los 3 meses (actual, -1, -2)
            const mesesCalcular = [];
            for (let i = 0; i < 3; i++) {
                const mesCalc = mesActual - i;
                let mes, anio;
                if (mesCalc >= 0) {
                    mes = mesCalc;
                    anio = anioActual;
                } else {
                    mes = 12 + mesCalc; // mesCalc es negativo
                    anio = anioActual - 1;
                }
                mesesCalcular.push({ mes, anio, nombre: mesesNombres[mes] });
            }

            // Calcular créditos y montos por mes (basado en fecha de creación/aprobación)
            const estadisticasMeses = mesesCalcular.map(mesInfo => {
                const creditosDelMes = creditosData.filter(credito => {
                    // Filtrar por fecha de creación (created_at)
                    if (!credito.created_at) return false;

                    const fechaCreacion = new Date(credito.created_at);
                    
                    // Verificar si la fecha de creación cae en este mes y año
                    return fechaCreacion.getMonth() === mesInfo.mes && 
                           fechaCreacion.getFullYear() === mesInfo.anio;
                });

                const montoMes = creditosDelMes.reduce((sum, c) => sum + (parseFloat(c.monto_aprobado) || 0), 0);
                const capitalMes = creditosDelMes.reduce((sum, c) => sum + parseEuropeanNumber(c.capital_restante), 0);
                
                // Agrupar por asesor para este mes
                const asesoresMes = {};
                creditosDelMes.forEach(credito => {
                    const asesor = credito.correo_asesor || 'Sin Asesor';
                    const nombreAsesor = credito.asesor_credito || asesor;
                    
                    if (!asesoresMes[asesor]) {
                        asesoresMes[asesor] = {
                            nombre: nombreAsesor,
                            count: 0,
                            monto: 0
                        };
                    }
                    asesoresMes[asesor].count++;
                    asesoresMes[asesor].monto += parseFloat(credito.monto_aprobado) || 0;
                });
                
                return {
                    nombre: mesInfo.nombre + ' ' + mesInfo.anio,
                    count: creditosDelMes.length,
                    monto: montoMes,
                    capital: capitalMes,
                    asesores: Object.values(asesoresMes).sort((a, b) => b.monto - a.monto)
                };
            });

            // Actualizar los elementos del DOM para los 3 meses
            estadisticasMeses.forEach((stat, index) => {
                document.getElementById(`dashboard-month-${index}-name`).textContent = stat.nombre;
                document.getElementById(`dashboard-month-${index}-count`).textContent = stat.count;
                document.getElementById(`dashboard-month-${index}-amount`).textContent = 
                    '$' + stat.monto.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                document.getElementById(`dashboard-month-${index}-capital`).textContent = 
                    '$' + formatEuropeanNumber(stat.capital);
                
                // Actualizar desglose por asesor
                const asesorContainer = document.getElementById(`dashboard-month-${index}-asesores`);
                if (asesorContainer) {
                    if (stat.asesores.length === 0) {
                        asesorContainer.innerHTML = '<p class="text-xs opacity-70 text-center py-2">Sin datos</p>';
                    } else {
                        asesorContainer.innerHTML = stat.asesores.map(asesor => `
                            <div class="flex justify-between items-center text-xs py-1 border-b border-white/10 last:border-0">
                                <span class="opacity-90 truncate flex-1" title="${asesor.nombre}">${asesor.nombre}</span>
                                <div class="flex items-center gap-2 ml-2">
                                    <span class="font-semibold">${asesor.count}</span>
                                    <span class="opacity-75">|</span>
                                    <span class="font-bold">$${asesor.monto.toLocaleString('es-ES', { maximumFractionDigits: 0 })}</span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            });

            // Actualizar métricas principales
            document.getElementById('dashboard-total-creditos').textContent = totalCreditos;
            document.getElementById('dashboard-monto-total').textContent = '$' + montoTotal.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('dashboard-capital-vigente').textContent = '$' + formatEuropeanNumber(capitalVigente);
            document.getElementById('dashboard-promedio-monto').textContent = '$' + promedioMonto.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('dashboard-total-asesores').textContent = totalAsesores;

            // Crear gráfico de barras de asesores
            const asesoresChart = document.getElementById('asesores-chart');
            const asesoresArray = Object.values(creditosPorAsesor).sort((a, b) => b.montoTotal - a.montoTotal);
            
            if (asesoresArray.length === 0) {
                asesoresChart.innerHTML = '<p class="text-gray-500 text-center py-4">No hay datos de asesores disponibles</p>';
                return;
            }

            // Calcular el porcentaje basado en el monto total global, no en el máximo individual
            const maxMonto = Math.max(...asesoresArray.map(a => a.montoTotal));

            asesoresChart.innerHTML = asesoresArray.map(asesor => {
                // Porcentaje real del total global
                const percentageOfTotal = montoTotal > 0 ? (asesor.montoTotal / montoTotal) * 100 : 0;
                // Porcentaje para el ancho visual de la barra (relativo al máximo)
                const percentageWidth = maxMonto > 0 ? (asesor.montoTotal / maxMonto) * 100 : 0;
                const promedioAsesor = asesor.totalCreditos > 0 ? asesor.montoTotal / asesor.totalCreditos : 0;
                
                return `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800 text-sm">${asesor.nombre}</p>
                                <p class="text-xs text-gray-500">${asesor.correo}</p>
                            </div>
                            <div class="text-right ml-4">
                                <p class="font-bold text-green-600 text-sm">$${asesor.montoTotal.toLocaleString('es-ES')}</p>
                                <p class="text-xs text-gray-500">${asesor.totalCreditos} crédito(s)</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-2" 
                                 style="width: ${percentageWidth}%">
                                <span class="text-white text-xs font-semibold">
                                    ${percentageOfTotal >= 10 ? percentageOfTotal.toFixed(0) + '%' : ''}
                                </span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-gray-600">
                                <i class="fas fa-chart-line mr-1"></i>
                                Promedio: $${promedioAsesor.toLocaleString('es-ES', { maximumFractionDigits: 0 })}
                            </p>
                            <p class="text-xs text-gray-600">
                                ${percentageOfTotal.toFixed(1)}% del total
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCreditosTable() {
            const tableBody = document.getElementById('creditos-table-body');
            
            if (filteredCreditos.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-semibold">No se encontraron registros</p>
                            <p class="text-gray-500 text-sm">No hay registros en tu cartera</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = filteredCreditos.map(credito => {
                const fecha = credito.fecha_hora ? new Date(credito.fecha_hora).toLocaleDateString('es-ES') : 'N/A';
                const montoFormateado = parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium text-right">${credito.acta || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${credito.nombre_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 text-right">${credito.cedula_socio || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold text-right">$${montoFormateado}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${credito.interes || 'N/A'}%</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${credito.plazo || 'N/A'} meses</td>
                        <td class="px-4 py-3 text-sm text-gray-600 truncate max-w-xs" title="${credito.asesor_credito || 'N/A'}">${credito.asesor_credito || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${fecha}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex gap-2">
                                <button onclick="viewCreditoDetails(${credito.id})" 
                                        class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded text-xs font-medium transition-colors">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="viewAmortizationTable(${credito.credito})" 
                                        class="bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded text-xs font-medium transition-colors"
                                        title="Ver Tabla de Amortización">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        function viewCreditoDetails(creditoId) {
            const credito = creditosData.find(c => c.id === creditoId);
            if (!credito) return;

            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Acta:</p>
                            <p class="text-gray-900">${credito.acta || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Sesión:</p>
                            <p class="text-gray-900">${credito.sesion || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Socio:</p>
                            <p class="text-gray-900">${credito.nombre_socio || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Cédula:</p>
                            <p class="text-gray-900">${credito.cedula_socio || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Teléfono:</p>
                            <p class="text-gray-900">${credito.telefono_socio || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Monto Aprobado:</p>
                            <p class="text-gray-900 font-bold text-green-600">$${parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES')}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Interés:</p>
                            <p class="text-gray-900">${credito.interes || 'N/A'}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Plazo:</p>
                            <p class="text-gray-900">${credito.plazo || 'N/A'} meses</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Frecuencia de Pago:</p>
                            <p class="text-gray-900">${credito.frecuencia_pago || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Día de Pago:</p>
                            <p class="text-gray-900">${credito.dia_pago || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Cuota Pagada:</p>
                            <p class="text-gray-900">${credito.cuota_pagada || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 font-semibold">Primer Pago:</p>
                            <p class="text-gray-900">${getMesAnioPrimerPago(credito) ? formatearPrimerPago(getMesAnioPrimerPago(credito), credito.dia_pago) : 'N/A'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600 font-semibold">Destino del Crédito:</p>
                            <p class="text-gray-900">${credito.destino_credito || 'N/A'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600 font-semibold">Asesor de Crédito:</p>
                            <p class="text-gray-900">${credito.asesor_credito || 'N/A'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600 font-semibold">Correo Asesor:</p>
                            <p class="text-gray-900">${credito.correo_asesor || 'N/A'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600 font-semibold">Observaciones:</p>
                            <p class="text-gray-900">${credito.observaciones || 'Sin observaciones'}</p>
                        </div>
                    </div>
                </div>
            `;

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 sticky top-0">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-file-invoice-dollar mr-3"></i>
                                Detalle del Crédito
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-white hover:text-gray-200 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        ${modalContent}
                    </div>
                    <div class="bg-gray-50 p-4 flex justify-end border-t">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Función para mostrar tabla de amortización de un crédito
        function viewAmortizationTable(creditoActa) {
            // Abrir la tabla de amortización en una nueva pestaña
            const url = `https://cajatupakrantina.webcoopec.com/view/${creditoActa}`;
            window.open(url, '_blank');
        }

        // Search functionality
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-creditos');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    if (!searchTerm) {
                        filteredCreditos = creditosData;
                    } else {
                        filteredCreditos = creditosData.filter(credito => {
                            return (
                                (credito.acta && credito.acta.toLowerCase().includes(searchTerm)) ||
                                (credito.nombre_socio && credito.nombre_socio.toLowerCase().includes(searchTerm)) ||
                                (credito.cedula_socio && credito.cedula_socio.toLowerCase().includes(searchTerm)) ||
                                (credito.asesor_credito && credito.asesor_credito.toLowerCase().includes(searchTerm)) ||
                                (credito.sesion && credito.sesion.toLowerCase().includes(searchTerm))
                            );
                        });
                    }
                    
                    updateCreditosStats();
                    renderCreditosTable();
                });
            }
        });
    </script>
    
    <!-- Screen Loader para Notificaciones -->
    <div id="notification-loader" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="flex flex-col items-center">
                <!-- Ícono Dinámico -->
                <div class="relative mb-6">
                    <div id="notification-loader-icon-container" class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center animate-pulse">
                        <i id="notification-loader-icon" class="fab fa-whatsapp text-white text-5xl"></i>
                    </div>
                    <div class="absolute -top-1 -right-1">
                        <div class="w-6 h-6 bg-blue-500 rounded-full animate-ping"></div>
                        <div class="absolute top-0 right-0 w-6 h-6 bg-blue-500 rounded-full"></div>
                    </div>
                </div>
                
                <!-- Mensaje -->
                <h3 id="notification-loader-title" class="text-xl font-bold text-gray-800 mb-2 text-center">Enviando notificación...</h3>
                <p id="notification-loader-message" class="text-gray-600 text-center mb-6">Por favor espera mientras se envía el mensaje por WhatsApp</p>
                
                <!-- Barra de progreso -->
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="notification-loader-progress" class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full animate-progress"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container para Mensajes -->
    <div id="custom-toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Modal de Confirmación General -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4">
            <div id="confirm-modal-header" class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h3 id="confirm-modal-title" class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-question-circle mr-3"></i>
                        Confirmar Acción
                    </h3>
                    <button onclick="closeConfirmModal()" 
                            class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p id="confirm-modal-message" class="text-gray-700 text-lg mb-6">
                    ¿Estás seguro de realizar esta acción?
                </p>
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" 
                            class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-colors">
                        Cancelar
                    </button>
                    <button id="confirm-modal-accept" 
                            class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold transition-colors shadow-md">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        .animate-progress {
            animation: progress 2s ease-in-out infinite;
        }
        
        /* Animación suave para texto de botones en hover */
        @keyframes slideInText {
            from {
                opacity: 0;
                transform: translateX(-5px);
                max-width: 0;
            }
            to {
                opacity: 1;
                transform: translateX(0);
                max-width: 100px;
            }
        }
        
        @keyframes slideOutText {
            from {
                opacity: 1;
                transform: translateX(0);
                max-width: 100px;
            }
            to {
                opacity: 0;
                transform: translateX(-5px);
                max-width: 0;
            }
        }
        
        /* Clase para el span del texto */
        .btn-text {
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            max-width: 0;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Cuando el grupo tiene hover, anima el texto */
        .group:hover .btn-text {
            max-width: 100px;
            opacity: 1;
            margin-left: 0.25rem;
        }
        
        /* Transición suave para el botón completo */
        .group {
            transition: all 0.2s ease-in-out;
        }
        
        /* Efecto de escala sutil en hover */
        @media (min-width: 768px) {
            .group:not(:disabled):hover {
                transform: scale(1.05);
            }
        }
    </style>

    <!-- Main application script -->
    <script src="main.js"></script>
    
    <!-- Initialize authentication on page load -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Loading screen is already visible via inline style
            
            // Check authentication status
            if (window.TupakAuth && window.TupakAuth.checkAuth) {
                await window.TupakAuth.checkAuth();
                
                // Cargar configuración de notificaciones del usuario
                const { data: { user } } = await supabase.auth.getUser();
                if (user && user.email) {
                    await loadUserNotificationConfig(user.email);
                }
                
                // Check cartera access after authentication
                if (typeof toggleCarteraTab === 'function') {
                    await toggleCarteraTab();
                }

                // Check comité access after authentication
                if (typeof toggleComiteTab === 'function') {
                    await toggleComiteTab();
                }
            } else {
                // Fallback: check auth after main.js loads
                setTimeout(async () => {
                    if (window.TupakAuth && window.TupakAuth.checkAuth) {
                        await window.TupakAuth.checkAuth();
                        
                        // Cargar configuración de notificaciones del usuario
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user && user.email) {
                            await loadUserNotificationConfig(user.email);
                        }
                        
                        // Check cartera access after authentication
                        if (typeof toggleCarteraTab === 'function') {
                            await toggleCarteraTab();
                        }

                        // Check comité access after authentication
                        if (typeof toggleComiteTab === 'function') {
                            await toggleComiteTab();
                        }
                    }
                }, 100);
            }
        });

        // ===== MODAL PARA ASIGNAR FECHA DE PAGO =====
        
        function openAsignarFechaModal(creditoId) {
            const credito = carteraDataCache?.data?.find(c => c.id === creditoId);
            if (!credito) {
                showCustomToast('No se encontró el crédito', 'error');
                return;
            }
            
            // Calcular próximo mes y año
            const hoy = new Date();
            const mesActual = hoy.getMonth(); // 0-11
            const anioActual = hoy.getFullYear();
            
            let mesPorDefecto = mesActual + 1; // Próximo mes
            let anioPorDefecto = anioActual;
            
            // Si el próximo mes es enero (mes 0), incrementar año
            if (mesPorDefecto > 11) {
                mesPorDefecto = 0;
                anioPorDefecto++;
            }
            
            const meses = [
                { valor: '01', nombre: 'Enero' },
                { valor: '02', nombre: 'Febrero' },
                { valor: '03', nombre: 'Marzo' },
                { valor: '04', nombre: 'Abril' },
                { valor: '05', nombre: 'Mayo' },
                { valor: '06', nombre: 'Junio' },
                { valor: '07', nombre: 'Julio' },
                { valor: '08', nombre: 'Agosto' },
                { valor: '09', nombre: 'Septiembre' },
                { valor: '10', nombre: 'Octubre' },
                { valor: '11', nombre: 'Noviembre' },
                { valor: '12', nombre: 'Diciembre' }
            ];
            
            const mesOptions = meses.map((mes, index) => {
                const selected = index === mesPorDefecto ? 'selected' : '';
                return `<option value="${mes.valor}" ${selected}>${mes.nombre}</option>`;
            }).join('');
            
            const anioInicio = anioActual;
            const anioFin = anioActual + 2;
            let anioOptions = '';
            for (let anio = anioInicio; anio <= anioFin; anio++) {
                const selected = anio === anioPorDefecto ? 'selected' : '';
                anioOptions += `<option value="${anio}" ${selected}>${anio}</option>`;
            }
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'modal-asignar-fecha';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-calendar-plus mr-3"></i>
                                Asignar Fecha de Pago
                            </h3>
                            <button onclick="closeAsignarFechaModal()" 
                                    class="text-white hover:text-gray-200 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600"><strong>Socio:</strong> ${credito.nombre_socio || 'N/A'}</p>
                            <p class="text-sm text-gray-600"><strong>Cédula:</strong> ${credito.cedula_socio || 'N/A'}</p>
                            <p class="text-sm text-gray-600"><strong>Monto:</strong> $${parseFloat(credito.monto_aprobado || 0).toLocaleString('es-ES')}</p>
                        </div>
                        
                        <form id="form-asignar-fecha" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-day mr-1"></i>
                                    Día de Pago (1-31)
                                </label>
                                <input type="number" 
                                       id="dia-pago" 
                                       min="1" 
                                       max="31" 
                                       required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                       placeholder="Ej: 15">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Mes del Primer Pago
                                </label>
                                <select id="mes-primer-pago" 
                                        required
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    ${mesOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar mr-1"></i>
                                    Año del Primer Pago
                                </label>
                                <select id="anio-primer-pago" 
                                        required
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    ${anioOptions}
                                </select>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="button" 
                                        onclick="closeAsignarFechaModal()"
                                        class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        class="flex-1 px-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-bold transition-colors shadow-md">
                                    <i class="fas fa-save mr-2"></i>
                                    Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Manejar envío del formulario
            document.getElementById('form-asignar-fecha').addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarFechaPago(creditoId);
            });
        }
        
        function closeAsignarFechaModal() {
            const modal = document.getElementById('modal-asignar-fecha');
            if (modal) {
                modal.remove();
            }
        }
        
        async function guardarFechaPago(creditoId) {
            try {
                const diaPago = document.getElementById('dia-pago').value;
                const mes = document.getElementById('mes-primer-pago').value;
                const anio = document.getElementById('anio-primer-pago').value;
                
                // Validar
                const dia = parseInt(diaPago);
                if (dia < 1 || dia > 31) {
                    alert('El día debe estar entre 1 y 31');
                    return;
                }
                
                // Formatear día con 2 dígitos
                const diaFormateado = dia.toString().padStart(2, '0');
                
                // Crear valor para mes_anio_primer_pago
                const mesAnioPrimerPago = `${mes}/${anio}`;
                
                console.log('Guardando fecha de pago:', {
                    creditoId,
                    dia_pago: diaFormateado,
                    mesAnioPrimerPago
                });
                
                // Primero verificar que el registro existe
                const { data: registroExistente, error: errorBusqueda } = await supabase
                    .from('actas_creditos_tupakra')
                    .select('*')
                    .eq('id', creditoId)
                    .single();
                
                if (errorBusqueda) {
                    console.error('❌ Error al buscar el registro:', errorBusqueda);
                    throw new Error('No se encontró el crédito con ID: ' + creditoId);
                }
                
                console.log('✅ Registro encontrado:', registroExistente);
                console.log('📋 Columnas disponibles:', Object.keys(registroExistente));
                
                // Actualizar usando el nombre correcto de la columna
                const updateData = {
                    'dia_pago': diaFormateado,
                    'mes_anio_primer_pago': mesAnioPrimerPago
                };
                
                console.log('📤 Datos a actualizar:', updateData);
                
                const { data, error } = await supabase
                    .from('actas_creditos_tupakra')
                    .update(updateData)
                    .eq('id', creditoId)
                    .select();
                
                console.log('📥 Resultado de actualización:', { data, error });
                
                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    throw new Error('No se pudo actualizar el registro. Posible problema de permisos RLS.');
                }
                
                console.log('✅ Actualización exitosa:', data[0]);
                
                // Cerrar modal
                closeAsignarFechaModal();
                
                // Recargar datos y actualizar vista
                carteraDataCache = null; // Limpiar caché
                await loadCobrosProximos();
                
                showCustomToast('Fecha de pago asignada correctamente', 'success');
                
            } catch (error) {
                console.error('Error al guardar fecha de pago:', error);
                showCustomToast('Error al guardar: ' + error.message, 'error');
            }
        }
    </script>

</body>
</html>





